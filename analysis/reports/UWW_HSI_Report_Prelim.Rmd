---
title: "Hydraulic Habitat Suitability Analysis, Upper Walla Walla Watershed"

author:
  - name: Tulley Mackey
    email: tulley.mackey@mthoodenvironmental.com
    institute: [mhe_salmon]
    correspondence: true
  - name: Mike Ackerman
    email: mike.ackerman@mthoodenvironmental.com
    institute: [mhe_mccall]
    correspondence: true
institute:
  - mhe_salmon: Mount Hood Environmental, 1009 South Daisy Street, Salmon, ID 83467, USA
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/journal-of-archaeological-science.csl"
bibliography:
  - AckermanLibrary.bib
always_allow_html: yes
---

<!-- the following inserts MHE logo into header -->

```{=html}
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"logo.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>
```

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)

options(knitr.kable.NA = '--')

``` 

```{r load-library, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

# load knitr for markdown
library(knitr)
library(kableExtra)

# load packages for analysis
library(tidyverse)
library(here)
library(ggpubr)
library(sf)
library(readxl)
library(ggmap)
library(nngeo)
library(janitor)
library(readr)
library(gridExtra)
library(reshape2)
library(dplyr)
library(ggplot2)

theme_set(theme_pubr(x.text.angle = 45,
                     base_size = 8))
```

# Background

Water is the cornerstone of First Foods production and inherently tied to the five fundamental touchstones: hydrology, geomorphology, habitat and network connectivity, riverine biotic community, and riparian vegetation [@Jones2008]. These touchstones form the Umatilla River Vision, a holistic approach to water quality restoration. In support of the Vision, population status and habitat use of riverine fishes defined as First Foods (including Endangered Species Act [ESA] listed middle Columbia River summer-run steelhead, spring-run Chinook salmon, bull trout, and Pacific lamprey have been identified as critical data needs in the assessment of biotic communities [@Jones2008]. 

In this document, we assess the hydraulic habitat suitability (HHS) in the upper Walla Walla watershed to support select life stages of spring-run Chinook salmon and summer-run steelhead. By comparing depth and velocity suitability curves for Chinook salmon and steelhead, developed by [@Maret2006], to continuous modeled depths and depth averaged velocities (supported by bathymetric Light Detection and Ranging; LiDAR) available for the upper Walla Walla watershed, we can further the understanding of how habitat, related specifically to hydraulics and the governing morphology, may be limiting recovery of Chinook salmon and steelhead. This information can help identify reaches at multiple scales where existing depth and velocity may be limiting particular species and life stages, which could prove useful for prioritizing habitat rehabilitation. The incorporation of a HHS analysis with habitat capacity (QRF), summer stream temperature, and morphological analyses allows for a robust assessment of the existing habitat conditions and limiting factors for target species and life stages.

## Objective

Our objective was to estimate the suitability of available depths and depth averaged velocities of reaches in the North Fork (NF), South Fork (SF), and upper mainstem Walla Walla (MS) rivers available from multi-year LiDAR sampling events that encompass the primary study area. We also evaluated the composite suitability throughout these reaches, calculated as the geometric mean of depth and velocity suitabilities. Suitability results were summarized both by river kilometers and geomorphic reaches. Hydraulic suitability was considered for both spring-run Chinook salmon (hereafter Chinook salmon) and Middle Columbia River summer-run steelhead (hereafter steelhead) at multiple life stages, including adult spawning and juvenile rearing for Chinook salmon and juvenile rearing for steelhead, and at base flow discharge scenarios (see Table \@ref(tab:scenarios-tab)). Hydraulic models were available from LiDAR for both 2019 (pre-flood) and 2021 (post-flood), and thus, we evaluate hydraulic suitability for both years to consider changes in HHS resulting from extensive flooding in 2020.

## Focal Species

The focal species for the HHS analyses were:

-   Chinook salmon (*Oncorhynchus tshawytscha*)
-   Steelhead (*O. mykiss*, ESA-listed "threatened")

While our HHS models specifically address Chinook salmon and steelhead, any uplift in habitat for these species are also expected to benefit:

-   Columbia River bull trout (*Salvelinus confluentus*; hereafter bull trout, ESA-listed "threatened")
-   Pacific lamprey (*Lampetra tridentata*)

## Study Area

The spatial domain of this assessment was limited to the sections of the mainstem upper Walla Walla River, and the North and South forks where LiDAR data and hydraulic model results were available. The downstream extent was defined by the mainstem's confluence with Dry Creek near Lowden, Washington, and upstream extents continued into the North and South forks, approximately 18.5 km (11.5 miles), and 33 km (20.5 miles), respectively. The assessment also includes approximately 38.5 km (24 miles) of the mainstem Walla Walla River (Table \@ref(tab:rkm-geo-rch)).


# Methods

We provide methods for calculating the depth, velocity, and composite suitability, including for each pixel in a raster, for a single "model scenario". A given scenario includes a species by life stage combination and a year (2019 or 2021). Suitability results were then summarized both by river kilometer (rkm) and geomorphic reach. For reference, Table \@ref(tab:rkm-geo-rch) shows the minimum and maximum river kilometer for each geomorphic reach and watershed. Here, we provide detailed methods for Scenario 1 in Table \@ref(tab:scenarios-tab): Chinook salmon juvenile rearing in 2019. The same methods were then applied across all scenarios using the appropriate depth and velocity curves (depending on species and adult versus juvenile) or differing input depth and depth averaged velocity rasters (depending on year). Scenarios evaluated are shown in Table \@ref(tab:scenarios-tab). Data, code, outputs, and reports for this analysis can be found in a GitHub repository at https://github.com/Mount-Hood-Environmental/UWW.plan.

Detailed methods are as follows:

1. Raster .tifs containing modeled depth and velocity values derived from 2019 LiDAR were imported into R [@RCoreTeam2021] with a raster pixel resolution of 1m x 1m. Rasters were provided by Rio Applied Science and Engineering (Rio ASE).

2. Import polygon shapefiles delineating river kilometers and geomorphic reaches. Shapefiles were used to "assign" each pixel to a river kilometer and geomorphic reach.

3. Read in the juvenile Chinook salmon rearing depth and velocity suitability curves from @Maret2006.  Functions to calculate the suitability for a given depth or velocity are available [here](https://github.com/Mount-Hood-Environmental/UWW.plan/analysis/scripts/hsi/hsi_curves.R). The [Suitability Curves] section below shows the suitability curves used from @Maret2006.

4. Use the suitability curves to calculate the depth and velocity suitability for each raster pixel. The result is two new rasters each containing the calculated depth and velocity suitability indices for each pixel, respectively.

5. Calculate the composite suitability value for each raster pixel as the geometric mean of the depth and velocity suitability values. The result is a third composite suitability raster.

6. Extract the depth, velocity, and composite suitability values located within each rkm and geomorphic reach for each pixel into a data frame. The resulting data frame can be used to summarize and visualize the suitability results by rkm or geomorphic reach for the juvenile Chinook salmon rearing in 2019.

7. Store the depth, velocity, and composite suitability values, rkms and geomorphic reaches for each pixel. These results are currently stored in the [output/hsi_raw/](https://github.com/Mount-Hood-Environmental/analysis/hsi_outputs) directory in the  [repo](https://github.com/Mount-Hood-Environmental/UWW.plan/).

8. Finally, calculate the total wetted area, weighted usable area, and normalized weighted usable area (i.e., HHS) for juvenile Chinook salmon by rkm and geomorphic reach. The total wetted area was calculated by counting the total number of pixels (each with an area of 1m^2), that occur within each rkm and geomorphic reach. The weighted usable area (WUA) was calculated by summing the composite suitability values of all pixels within that same area. And finally, the normalized weighted usable area i.e., HHS, was calculated by dividing the WUA by the total wetted area for each rkm and geomorphic reach.

The process can then be repeated for each model "run" (Table \@ref(tab:scenarios-tab)). The resulting raster .tifs are also available in the GitHub repository at https://github.com/Mount-Hood-Environmental/UWW.plan. 

Finally, suitability values were summarized and visualized by year, species, and life stage (Chinook salmon adult spawning, Chinook salmon and steelhead juvenile rearing), and rkm / geomorphic reach. Box plots were used to show the distribution of depth, velocity, and composite suitability values and are provided in the [Results]. Maps showing the depth and velocity suitability and HHS by rkm are provided by species and life stage, as well as plots showing the HHS, by year, for each species and life stage. Additional summaries of results are provided in the [Supplemental Tables and Figures] section.

```{r rkm-geo-rch}
geo_order = c("GR_01_MS", 
              "GR_02_MS", 
              "GR_03_MS", 
              "GR_04_MS", 
              "GR_05_MS", 
              "GR_01_NF", 
              "GR_02_NF", 
              "GR_03_NF", 
              "GR_04_NF",
              "GR_05_NF", 
              "GR_01_SF", 
              "GR_02_SF", 
              "GR_03_SF", 
              "GR_04_SF", 
              "GR_05_SF")

geo_reach = read_csv(here("analysis/data/raw_data/reach_partitions/Geo_reaches_corrected.csv")) %>%
  rename(Watershed = Strm_Name,
         `Min rkm` = From_RKM,
         `Max rkm` = To_RKM,
         `Geomorphic Reach` = Reach_ID) %>%
  mutate(`Length (km)` = round(Shape_Leng / 1000, 1)) %>%
  select(`Geomorphic Reach`,
         Watershed,
         `Min rkm`,
         `Max rkm`,
         `Length (km)`) %>%
  mutate(`Geomorphic Reach` = factor(`Geomorphic Reach`, levels = geo_order)) %>%
  arrange(`Geomorphic Reach`) %>%
  kable(booktabs = T,
        align = "ccccc",
        caption = "The minimum and maximum river kilometer and length of each geomorphic reach. River kilometers increase moving upstream.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))
geo_reach

```

```{r scenarios-tab}
scenarios_tab = tibble(Scenario = c(1:6),
                       Species = c("Chinook salmon", "Chinook salmon", "Chinook salmon", "Chinook salmon", "Steelhead", "Steelhead"),
                       `Life Stage` = c("Juvenile", "Juvenile", "Spawning", "Spawning", "Juvenile", "Juvenile"),
                       Year = c("2019", "2021", "2019", "2021", "2019", "2021"),
                       `Depth Raster` = c("Combined_2019lidar_LowFlow_Depth_metric.tif",
                                          "Combined_2021lidar_LowFlow_Depth_metric.tif",
                                          "Combined_2019lidar_LowFlow_Depth_metric.tif",
                                          "Combined_2021lidar_LowFlow_Depth_metric.tif",
                                          "Combined_2019lidar_LowFlow_Depth_metric.tif",
                                          "Combined_2021lidar_LowFlow_Depth_metric.tif"),
                       `Velocity Raster` = c("Combined_2019lidar_LowFlow_Velocity_metric.tif",
                                             "Combined_2021lidar_LowFlow_Velocity_metric.tif",
                                             "Combined_2019lidar_LowFlow_Velocity_metric.tif",
                                             "Combined_2021lidar_LowFlow_Velocity_metric.tif",
                                             "Combined_2019lidar_LowFlow_Velocity_metric.tif",
                                             "Combined_2021lidar_LowFlow_Velocity_metric.tif")) %>%
  kable(booktabs = T,
        align = "cccccc",
        caption = "Model scenarios for which we evaluated depth, velocity, and composite suitabilites including the corresponding depth and velocity rasters used for each scenario.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))
scenarios_tab

```

## Suitability Curves

```{r hsi-curves}
hsi_df = read_csv(here("analysis/data/raw_data/maret_hsi_curves_for_r_uww.csv"))

```

Depth and velocity suitability curves for Chinook salmon and steelhead were derived from @Maret2006 (Figures \@ref(fig:chnk-hsi) and \@ref(fig:sthd-hsi)). These curves were used to calculate the depth or velocity suitability for each pixel within a given scenario. As an example, using juvenile Chinook salmon and depth, if a pixel has a depth of 0 m, that pixel is assigned a suitability of 0 whereas if the depth is greater than approximately 0.6 m it is assigned a suitability of 1. A depth of 0.5 m would be assigned a suitability of $\sim$ 0.7. The composite suitability for a pixel is then calculated as the geometric mean of the depth and velocity suitability values.

```{r chnk-hsi, fig.height = 4, fig.cap = "Suitability indices at varying depths and velocities for juvenile rearing and adult spawning for Chinook salmon from Maret et al. (2006)."}
# chinook hsi curves
chnk_hsi = hsi_df %>%
  filter(species == "Chinook") %>%
  ggplot(aes(x = value_m, y = si)) +
  geom_line(color = "royalblue3", size = 1.5) +
  coord_cartesian(xlim = c(0,2)) +
  theme_bw() +
  facet_grid(variable ~ life_stage) +
  labs(x = "Value (m | m/s)",
       y = "Suitability Index",
       title = "Chinook salmon")
chnk_hsi

```

```{r sthd-hsi, fig.height = 4, fig.cap = "Suitability indices at varying depths and velocities for juvenile rearing for steelhead from Maret et al. (2006)."}
sthd_hsi = hsi_df %>%
  filter(species == "Steelhead") %>%
  ggplot(aes(x = value_m, y = si)) +
  geom_line(color = "royalblue3", size = 1.5) +
  coord_cartesian(xlim = c(0,2)) +
  theme_bw() +
  facet_grid( life_stage ~ variable) +
  labs(x = "Value (m | m/s)",
       y = "Suitability Index",
       title = "Steelhead")
sthd_hsi

```


# Results

```{r raw-results}
# read raw hsi results files for each species/life stage and year and merge into one df
hsi_raw = list.files("S:/main/data/habitat/HSI/UWW_hsi_results/raw_results", pattern = "*.rda", full.names = T) %>%
  map_df(~read_rds(.)) %>%
  as_tibble() %>%
  mutate(watershed = case_when(
    grepl("MS", ID) ~ "Mainstem",
    grepl("NF", ID) ~ "North Fork",
    grepl("SF", ID) ~ "South Fork"
  ),
  Reach_ID_adjust = recode(ID, RKM_01_MS = "RKM_44_MS", RKM_02_MS = "RKM_45_MS", RKM_03_MS = "RKM_46_MS", 
  RKM_04_MS = "RKM_47_MS",RKM_05_MS = "RKM_48_MS",RKM_06_MS = "RKM_49_MS",RKM_07_MS = "RKM_50_MS",
  RKM_08_MS = "RKM_51_MS",RKM_09_MS = "RKM_52_MS",RKM_10_MS = "RKM_53_MS",RKM_11_MS = "RKM_54_MS",
  RKM_12_MS = "RKM_55_MS",RKM_13_MS = "RKM_56_MS",RKM_14_MS = "RKM_57_MS",RKM_15_MS = "RKM_58_MS",
  RKM_16_MS = "RKM_59_MS",RKM_17_MS = "RKM_60_MS",RKM_18_MS = "RKM_61_MS",RKM_19_MS = "RKM_62_MS",
  RKM_20_MS = "RKM_63_MS",RKM_21_MS = "RKM_64_MS",RKM_22_MS = "RKM_65_MS",RKM_23_MS = "RKM_66_MS",
  RKM_24_MS = "RKM_67_MS",RKM_25_MS = "RKM_68_MS",RKM_26_MS = "RKM_69_MS",RKM_27_MS = "RKM_70_MS",
  RKM_28_MS = "RKM_71_MS",RKM_29_MS = "RKM_72_MS",RKM_30_MS = "RKM_73_MS",RKM_31_MS = "RKM_74_MS",
  RKM_32_MS = "RKM_75_MS",RKM_33_MS = "RKM_76_MS",RKM_34_MS = "RKM_77_MS",RKM_35_MS = "RKM_78_MS",
  RKM_36_MS = "RKM_79_MS",RKM_37_MS = "RKM_80_MS",RKM_38_MS = "RKM_81_MS",RKM_39_MS = "RKM_82_MS"))

```

```{r hhs-results, results = 'hide'}
rkm = st_read(here("analysis/data/derived_data/hsi/rkm_poly.shp")) %>%
  select(Reach_ID, Strm_Name, geometry) %>%
  rename(watershed = Strm_Name)

geo = st_read(here("analysis/data/derived_data/hsi/geom_buffer.shp")) %>%
  select(Reach, geometry)

geo_ms = geo %>%
  filter(str_starts(Reach, "MS"))
geo_nf = geo %>%
  filter(str_starts(Reach, "NF"))
geo_sf = geo %>%
  filter(str_starts(Reach, "SF"))

hhs_rkm = list.files(here("analysis/hsi_outputs/csvs/"), pattern = "*.csv", full.names = T) %>%
  map_df(~ read_csv(.)) %>%
  rename(Reach_ID = ID) %>%
  filter(str_starts(Reach_ID, "RKM")) %>%
  mutate(Reach_ID_adjust = recode(Reach_ID, RKM_01_MS = "RKM_44_MS", RKM_02_MS = "RKM_45_MS", RKM_03_MS = "RKM_46_MS", RKM_04_MS = "RKM_47_MS",
                           RKM_05_MS = "RKM_48_MS",RKM_06_MS = "RKM_49_MS",RKM_07_MS = "RKM_50_MS",RKM_08_MS = "RKM_51_MS",
                           RKM_09_MS = "RKM_52_MS",RKM_10_MS = "RKM_53_MS",RKM_11_MS = "RKM_54_MS",RKM_12_MS = "RKM_55_MS",
                           RKM_13_MS = "RKM_56_MS",RKM_14_MS = "RKM_57_MS",RKM_15_MS = "RKM_58_MS",RKM_16_MS = "RKM_59_MS",
                           RKM_17_MS = "RKM_60_MS",RKM_18_MS = "RKM_61_MS",RKM_19_MS = "RKM_62_MS",RKM_20_MS = "RKM_63_MS",
                           RKM_21_MS = "RKM_64_MS",RKM_22_MS = "RKM_65_MS",RKM_23_MS = "RKM_66_MS",RKM_24_MS = "RKM_67_MS",
                           RKM_25_MS = "RKM_68_MS",RKM_26_MS = "RKM_69_MS",RKM_27_MS = "RKM_70_MS",RKM_28_MS = "RKM_71_MS",
                           RKM_29_MS = "RKM_72_MS",RKM_30_MS = "RKM_73_MS",RKM_31_MS = "RKM_74_MS",RKM_32_MS = "RKM_75_MS",
                           RKM_33_MS = "RKM_76_MS",RKM_34_MS = "RKM_77_MS",RKM_35_MS = "RKM_78_MS",RKM_36_MS = "RKM_79_MS",
                           RKM_37_MS = "RKM_80_MS",RKM_38_MS = "RKM_81_MS",RKM_39_MS = "RKM_82_MS"))

hhs_geo = list.files(here("analysis/hsi_outputs/csvs/"), pattern = "*.csv", full.names = T) %>%
  map_df(~ read_csv(.)) %>%
  rename(Reach_ID = ID) %>%
  filter(str_starts(Reach_ID, "GR"))

```

Here, we summarize depth, depth averaged velocity, and composite suitability results for the mainstem, North Fork, and South Fork rivers within the primary study area. Results are parsed by each species and life stage considered including Chinook salmon spawning, Chinook salmon juvenile rearing, and steelhead juvenile rearing. First, we summarize the distribution of suitability values by geomorphic reach. Results are also provided spatially as maps; those results are summarized and displayed by rkm, but we provide geomorphic reach delineations to place results in context. We focus primarily on results from 2021 to describe "current" hydraulic suitability; however, HHS results for 2019 are also provided by rkm to understand hydraulic conditions prior to extensive flooding in 2020 and to draw comparison to current conditions. Additional results, including higher-resolution summaries and results for 2019, are additionally provided in the [Supplemental Tables and Figures] section. 

## Chinook Salmon Spawning

The composite hydraulic suitability for spawning is highly variable across the three watersheds, with the South Fork Walla Walla River, on average, being most suitable (Figures \@ref(fig:uww-chnk-spw-plot) and \@ref(fig:chnk-spw-map)). The mainstem Walla Walla River exhibits the greatest intravariability, where geomrophic reaches four and five are most suitable, reaches one and two are least suitable, and reach three is in between. For mainstem reaches 1-3 (44.1-72.8 rkm), velocities limit suitability, and both depth and velocity are limiting in the North Fork. In contrast, the South Fork exhibits very suitable velocities for spawning, and moderate to high depth suitability too. Comparing the HHS by river kilometer between 2019 and 2021, it appears little change in HHS resulting from the flooding event in 2020 (Figure \@ref(fig:chnk-spw-hhs)). In general, HHS in the South Fork Walla Walla watershed and in the mainstem Walla Walla above approximately rkm 75 appear relatively suitable with average HHS above 0.65; however, HHS in downstream reaches of the mainstem and in the North Fork Walla Walla River are generally poor for Chinook salmon spawning.

```{r uww-chnk-spw-plot, fig.height = 7, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon spawning** across geomorphic reaches in the Upper Walla Walla watershed in 2021."}
# Chinook salmon spawning, 2021
chnk_spw_2021_geo = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_spw",
         str_starts(ID, "GR")) %>%
  mutate(ID = factor(ID, levels = geo_order)) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = watershed)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "Geomorphic Reach",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_spw_2021_geo
#ggsave("../output/figures/ul_cs_plot.pdf", ul_p)

```

```{r chnk-spw-map, fig.height = 7, results = 'hide', fig.cap = "Map showing the hydraulic habitat suitability for **Chinook salmon spawning** in the Upper Walla Walla watershed for 2021, plotted by river kilometer with geomorphic reaches shown."}
# Chinook spawning map
chnk_spw_map = merge(rkm, hhs_rkm, by = "Reach_ID") %>%
  filter(scenario == "chnk_spw", year == "2021") %>%
  select(Reach_ID,
         year,
         Composite = HHS,
         Depth = d_HSI,
         Velocity = v_HSI) %>%
  pivot_longer(cols = c("Composite", 
                        "Depth", 
                        "Velocity"),
               names_to = "suitability",
               values_to = "value") %>%
  mutate(suitability = factor(suitability, levels = c("Composite",
                                                      "Depth",
                                                      "Velocity"))) %>%
  ggplot() +
  geom_sf(aes(fill = value),
          colour = NA) +
  scale_fill_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Suitability Index") +
  geom_sf(data = geo,
          color = "grey50",
          fill = NA) +
  geom_sf_text(data = geo_ms,
               aes(label = Reach),
               color = "black",
               size = 2,
               nudge_x = -4000,
               nudge_y = -1000) +
  geom_sf_text(data = geo_nf, aes(label = Reach),
               color = 'black',
               size = 2,
               nudge_x = 50,
               nudge_y = 2000) +
  geom_sf_text(data = geo_sf, aes(label = Reach),
               color = 'black',
               size = 2,
               nudge_x = 50,
               nudge_y = -3000) +
  theme_classic() +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "left") +
 facet_wrap(~ suitability, nrow = 3)
chnk_spw_map  

```

```{r chnk-spw-hhs, fig.height = 3, fig.cap = "Hydraulic habitat suitability (composite) by river kilometer for **Chinook salmon spawning** for 2019 and 2021."}
chnk_spw_hhs_p = hhs_rkm %>%
  filter(scenario == "chnk_spw") %>%
  select(scenario,
         year,
         Reach_ID,
         Reach_ID_adjust,
         HHS) %>%
  mutate(watershed = case_when(
    grepl("MS", Reach_ID) ~ "Mainstem",
    grepl("NF", Reach_ID) ~ "North Fork",
    grepl("SF", Reach_ID) ~ "South Fork"
  )) %>%
  mutate(rkm = as.numeric(substr(Reach_ID_adjust, 5, 6)),
         year = as.factor(year)) %>%
  ggplot(aes(x = rkm)) +
  # geom_line(aes(y = HHS), color = "royalblue4", size = 0.5) +
  # geom_smooth(aes(y = HHS), color = "royalblue4", se = F, size = 1.1) +
  geom_line(aes(y = HHS, color = year), size = 0.5) +
  geom_smooth(aes(y = HHS, color = year), se = F, size = 1.1) +
  ylim(0,1) +
  facet_wrap(~ watershed, scales = "free_x") +
  labs(x = "River Kilometer",
       y = "Hydraulic Suitability",
       color = "Year") +
  theme_classic() +
  theme(legend.position = "top")
chnk_spw_hhs_p

```

## Chinook Salmon Juvenile Rearing

Among species and life stages, composite hydraulic suitability is lowest for Chinook salmon juvenile rearing (Figure \@ref(fig:uww-chnk-juv-plot)). Composite suitability is relatively low across all geomorphic reaches and watersheds and lowest in the South Fork Walla Walla watershed; three geomorphic reaches in the mainstem Walla Walla (01 - 02) appear moderate, but still below 0.50 (Figure \@ref(fig:uww-chnk-juv-plot)). Depth appears to be a limiting factor for Chinook salmon juvenile rearing in all three watersheds, with velocities being mostly suitable in the mainstem and North Fork, but unsuitable in the South Fork. In general, HHS for Chinook salmon juvenile rearing is poor in all watersheds, with only lower portions of the mainstem (approximately below rkm 65) being moderately suitable (Figures \@ref(fig:chnk-juv-map) and \@ref(fig:chnk-juv-hhs)). Similar to spawning, average HHS by rkm for Chinook salmon rearing changed little from 2019 to 2021 (Figure \@ref(fig:chnk-juv-hhs))

```{r uww-chnk-juv-plot, fig.height = 7, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon juvenile rearing** across geomorphic reaches in the Upper Walla Walla watershed in 2021."}
# Chinook juvenile rearing, 2021
chnk_juv_2021_geo = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_juv",
         str_starts(ID, "GR")) %>%
  mutate(ID = factor(ID, levels = geo_order)) %>%
  ggplot(aes(x = ID,
             y = value,
             fill = watershed)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "Geomorphic Reach",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_juv_2021_geo

```

```{r chnk-juv-map, results = 'hide', fig.height = 7, fig.cap = "Map showing the hydraulic habitat suitability for **Chinook salmon juvenile rearing** in the Upper Walla Walla watershed for 2019 and 2021, plotted by river kilometer with geomorphic reaches shown."}
# Chinook juvenile rearing map
chnk_juv_map = merge(rkm, hhs_rkm, by = "Reach_ID") %>%
  filter(scenario == "chnk_juv", year == "2021") %>%
  select(Reach_ID,
         year,
         Composite = HHS,
         Depth = d_HSI,
         Velocity = v_HSI) %>%
  pivot_longer(cols = c("Composite", 
                        "Depth", 
                        "Velocity"),
               names_to = "suitability",
               values_to = "value") %>%
  mutate(suitability = factor(suitability, levels = c("Composite",
                                                      "Depth",
                                                      "Velocity"))) %>% 
  ggplot() +
  geom_sf(aes(fill = value),
          colour = NA) +
  scale_fill_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Suitability Index") +
  geom_sf(data = geo,
          color = "grey50",
          fill = NA) +
  geom_sf_text(data = geo_ms,
               aes(label = Reach),
               color = "black",
               size = 2,
               nudge_x = -4000,
               nudge_y = -1000) +
  geom_sf_text(data = geo_nf, aes(label = Reach),
               color = 'black',
               size = 2,
               nudge_x = 50,
               nudge_y = 2000) +
  geom_sf_text(data = geo_sf, aes(label = Reach),
               color = 'black',
               size = 2,
               nudge_x = 50,
               nudge_y = -3000) +
  theme_classic() +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "left") +
  facet_wrap(~ suitability, nrow = 3)
chnk_juv_map  

```

```{r chnk-juv-hhs, fig.height = 3, fig.cap = "Hydraulic habitat suitability (composite) by river kilometer for **Chinook salmon juvenile rearing** for 2019 and 2021."}
chnk_juv_hhs_p = hhs_rkm %>%
  filter(scenario == "chnk_juv") %>%
  select(scenario,
         year,
         Reach_ID,
         Reach_ID_adjust,
         HHS) %>%
  mutate(watershed = case_when(
    grepl("MS", Reach_ID) ~ "Mainstem",
    grepl("NF", Reach_ID) ~ "North Fork",
    grepl("SF", Reach_ID) ~ "South Fork"
  )) %>%
  mutate(rkm = as.numeric(substr(Reach_ID_adjust, 5, 6)),
         year = as.factor(year)) %>%
  ggplot(aes(x = rkm)) +
  geom_line(aes(y = HHS, color = year), size = 0.5) +
  geom_smooth(aes(y = HHS, color = year), se = F, size = 1.1) +
  ylim(0,1) +
  facet_wrap(~ watershed, scales = "free_x") +
  labs(x = "River Kilometer",
       y = "Hydraulic Suitability",
       color = "Year") +
  theme_classic() +
  theme(legend.position = "top")
chnk_juv_hhs_p

```

## Steelhead Juvenile Rearing

Composite suitability for steelhead juvenile rearing is moderate to high in both the mainstem and South Fork watersheds (Figure \@ref(fig:uww-sthd-juv-plot)). ydraulic habitat conditions are less suitable (moderate) in the North Fork, largely due to lower suitability of available depths (Figures \@ref(fig:uww-sthd-juv-plot) and \@ref(fig:sthd-juv-map)). The distribution of velocity suitabilities across all three watershed are consistently higher. Figure \@ref(fig:sthd-juv-hhs) also shows that HHS among all three watersheds is moderate to high for steelhead juvenile rearing. Again, there is little difference in the average suitability by river kilometer from 2019 to 2021 for steelhead juvenile rearing (Figure \@ref(fig:sthd-juv-hhs)).

```{r uww-sthd-juv-plot, fig.height = 7, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **steelhead juvenile rearing** across geomorphic reaches in the Upper Walla Walla watershed in 2021."}
# steelhead juvenile rearing, 2021
sthd_juv_2021_geo = hsi_raw %>%
  filter(year == "2021",
         scenario == "sthd_juv",
         str_starts(ID, "GR")) %>%
  mutate(ID = factor(ID, levels = geo_order)) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = watershed)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "Geomorphic Reach",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, vjust = 0.5),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
sthd_juv_2021_geo

```

```{r sthd-juv-map, results = 'hide', fig.height = 7, fig.cap = "Map showing the hydraulic habitat suitability for **steelhead juvenile rearing** in the Upper Walla Walla watershed for 2019 and 2021, plotted by river kilometer with geomorphic reaches shown."}
# steelhead juvenile rearing map
sthd_juv_map = merge(rkm, hhs_rkm, by = "Reach_ID") %>%
  filter(scenario == "sthd_juv", year == "2021") %>%
  select(Reach_ID,
         year,
         Composite = HHS,
         Depth = d_HSI,
         Velocity = v_HSI) %>%
  pivot_longer(cols = c("Composite", 
                        "Depth", 
                        "Velocity"),
               names_to = "suitability",
               values_to = "value") %>%
  mutate(suitability = factor(suitability, levels = c("Composite",
                                                      "Depth",
                                                      "Velocity"))) %>%
  ggplot() +
  geom_sf(aes(fill = value),
          colour = NA) +
  scale_fill_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Suitability Index") +
  geom_sf(data = geo,
          color = "grey50",
          fill = NA) +
  geom_sf_text(data = geo_ms,
               aes(label = Reach),
               color = "black",
               size = 2,
               nudge_x = -4000,
               nudge_y = -1000) +
  geom_sf_text(data = geo_nf, aes(label = Reach),
               color = 'black',
               size = 2,
               nudge_x = 50,
               nudge_y = 2000) +
  geom_sf_text(data = geo_sf, aes(label = Reach),
               color = 'black',
               size = 2,
               nudge_x = 50,
               nudge_y = -3000) +
  theme_classic() +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "left") +
  facet_wrap(~ suitability, nrow = 3)
sthd_juv_map  

```

```{r sthd-juv-hhs, fig.height = 3, fig.cap = "Hydraulic habitat suitability (composite) by river kilometer for **steelhead juvenile rearing** for 2019 and 2021."}
sthd_juv_hhs_p = hhs_rkm %>%
  filter(scenario == "sthd_juv") %>%
  select(scenario,
         year,
         Reach_ID,
         Reach_ID_adjust,
         HHS) %>%
  mutate(watershed = case_when(
    grepl("MS", Reach_ID) ~ "Mainstem",
    grepl("NF", Reach_ID) ~ "North Fork",
    grepl("SF", Reach_ID) ~ "South Fork"
  )) %>%
  mutate(rkm = as.numeric(substr(Reach_ID_adjust, 5, 6)),
         year = as.factor(year)) %>%
  ggplot(aes(x = rkm)) +
  geom_line(aes(y = HHS, color = year), size = 0.5) +
  geom_smooth(aes(y = HHS, color = year), se = F, size = 1.1) +
  ylim(0,1) +
  facet_wrap(~ watershed, scales = "free_x") +
  labs(x = "River Kilometer",
       y = "Hydraulic Suitability",
       color = "Year") +
  theme_classic() +
  theme(legend.position = "top")
sthd_juv_hhs_p

```

# Discussion

Composite hydraulic suitability in the upper Walla Walla River watershed at base flow appears to be most suitable for steelhead juvenile rearing and least suitable for Chinook salmon juvenile rearing.  Suitable habitat for steelhead juveniles includes a tolerance for slightly shallower depths and higher velocities when compared to Chinook salmon juveniles. A lack of habitat with depths greater than 0.25 meters at low flows appears to limit Chinook salmon rearing throughout the upper Walla Walla watershed, with velocities contributing to unsuitable conditions in the South Fork. Chinook salmon spawning composite suitability is more variable, with suitable spawning conditions in the South Fork, unsuitable conditions in the North Fork and a wide distribution across reaches in the mainstem. Depth is limiting for all three species and life stages in the North Fork, but interestingly, North Fork velocities appear to be suitable for Chinook salmon rearing. This is counter-intuitive as shallower habitat is sometimes associated with higher velocities found in riffles and rapids.

## Other Focal Species

Based on habitat preference information from the South Fork Walla Walla River [@Al-Chokhachy2007], adult (>220mm) and juvenile (<220mm) bull trout prefer similar hydraulic habitat defined by low velocities near the river bed. Juvenile bull trout appear to tolerate shallower depths (0.4m-1m) than adults (>1m). Hydraulic preferences for juvenile bull trout align closest with Chinook salmon juvenile suitability curves used in this analysis. As discussed above, of the three species and life stages analyzed, HHS is most limiting for Chinook salmon juvenile rearing, indicating that similar limitations may exist for juvenile bull trout in the upper Walla Walla watershed. Understanding depth preferences of adult bull trout may prove useful for rehabilitation design, helping to mitigate creation of habitat that will encourage predation of juvenile Chinook and steelhead. A literature review of Pacific lamprey habitat preferences did not yield any hydraulic suitability information, prohibiting further discussion on the species.

## Model Limitations

While this HHS analysis provide insight on hydraulic conditions in the Upper Walla Walla watershed to support Chinook salmon spawning and rearing, and steelhead rearing, during base flow conditions, it should be viewed in the context of fish habitat preferences holistically. It is generally accepted that high quality salmonid habitat is comprised of a multitude of habitat characteristics in addition to appropriate depths and velocity. For example, high quality spawning and rearing habitat typically contains sufficient cover, appropriate water temperatures, available food, etc. Because of this, we encourage the integration of the information summarized here with other biological and geomorphic assessments provided for the upper Walla Walla watershed to inform rehabilitation efforts and target conditions to address limiting factors. 

Moreover, HHS are univariate by nature. That is, the suitability of depths and depth averaged velocities are considered independently of each other, and do not consider relationships with other variable e.g., temperature. For example, as stream temperatures exceed optimal or maximum temperature thresholds, higher water velocities may become less suitable for a given species or life stage. Similar, cover (e.g., large woody debris, boulders) may provide small-scale refuge from high stream velocities and increase the suitability of a pixel or channel unit not captured by HHS analysis.    

The scale of inference used in this HHS analysis must also be taken into account when considering results. Suitability summarized at the  geomorphic reach and river kilometer scale likely does not capture all the hydraulic nuances at the microhabitat scale that fish take advantage of and prefer. The analysis output rasters, which display composite, depth, and depth averaged velocity suitability at a 1m x 1m (pixel) resolution can be used for further microhabitat analysis, and can be found in the [output/hsi_raw/](https://github.com/Mount-Hood-Environmental/analysis/hsi_outputs) directory in the  [repo](https://github.com/Mount-Hood-Environmental/UWW.plan/). 

# Literature Cited

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::


# Supplemental Tables and Figures

## Geomorphic Reach Results

```{r hhs-table}
hhs_tbl = hhs_geo %>%
  mutate(Watershed = case_when(
    grepl("MS", Reach_ID) ~ "Mainstem",
    grepl("NF", Reach_ID) ~ "North Fork",
    grepl("SF", Reach_ID) ~ "South Fork"
  )) %>%
  select(
    Scenario = scenario,
    Watershed,
    Reach = Reach_ID,
    Year = year,
    `Area m2` = area_m2,
    WUA,
    HHS,
    `Depth Suitability` = d_HSI,
    `Velocity Suitability` = v_HSI
  ) %>%
  mutate(
    WUA = round(WUA, 0),
    HHS = round(HHS, 2),
    `Depth Suitability` = round(`Depth Suitability`, 2),
    `Velocity Suitability` = round(`Velocity Suitability`, 2)
  ) %>%
  mutate(Scenario = recode(Scenario,
                           "chnk_spw" = "Chinook Spawning",
                           "chnk_juv" = "Chinook Juvenile",
                           "sthd_juv" = "Steelhead Juvenile")) %>%
  arrange(Scenario,
          Watershed,
          Reach) %>%
  kable(booktabs = T,
        align = "lcccccccc",
        caption = "Composite (HHS), depth, and velocity suitability values, area, and weighted usable area (WUA) by scenario, geomorphic reach, and year in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))
hhs_tbl

```

## Suitability Distributions, 2019 versus 2021

```{r chnk-spw-box-p, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon spawning** across geomorphic reaches in the Upper Walla Walla watershed, 2019 and 2021."}
chnk_spw_box_p = hsi_raw %>%
  filter(scenario == "chnk_spw",
         str_starts(ID, "GR")) %>%
  mutate(ID = factor(ID, levels = geo_order)) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = watershed)) +
  geom_boxplot() +
  facet_grid(metric ~ year) +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_spw_box_p  

```

```{r chnk-juv-box-p, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon juvenile rearing** across geomorphic reaches in the Upper Walla Walla watershed, 2019 and 2021."}
chnk_juv_box_p = hsi_raw %>%
  filter(scenario == "chnk_juv",
         str_starts(ID, "GR")) %>%
  mutate(ID = factor(ID, levels = geo_order)) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = watershed)) +
  geom_boxplot() +
  facet_grid(metric ~ year) +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_juv_box_p  

```

```{r sthd-juv-box-p, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **steelhead juvenile rearing** across geomorphic reaches in the Upper Walla Walla watershed, 2019 and 2021."}
sthd_juv_box_p = hsi_raw %>%
  filter(scenario == "sthd_juv",
         str_starts(ID, "GR")) %>%
  mutate(ID = factor(ID, levels = geo_order)) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = watershed)) +
  geom_boxplot() +
  facet_grid(metric ~ year) +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
sthd_juv_box_p  

```

## Distributions by Watershed and RKM

### Chinook Salmon Spawning, 2021

```{r chnk-spw-box-rkm-ms, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon spawning** across river kilometers in the **mainstem** Upper Walla Walla River, 2021."}
# Box-plot by rkm, Chinook spawning, mainstem
chnk_spw_2021_rkm_ms = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_spw",
         str_starts(ID, "RKM"),
         str_ends(ID, "MS")) %>%
  ggplot(aes(x = Reach_ID_adjust, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_spw_2021_rkm_ms

```

```{r chnk-spw-box-rkm-nf, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon spawning** across river kilometers in the **North Fork** Walla Walla River, 2021."}
# Box-plot by rkm, Chinook spawning, North Fork
chnk_spw_2021_rkm_nf = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_spw",
         str_starts(ID, "RKM"),
         str_ends(ID, "NF")) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_spw_2021_rkm_nf

```

```{r chnk-spw-box-rkm-sf, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon spawning** across river kilometers in the **South Fork** Walla Walla River, 2021."}
# Box-plot by rkm, Chinook spawning, South Fork
chnk_spw_2021_rkm_sf = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_spw",
         str_starts(ID, "RKM"),
         str_ends(ID, "SF")) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_spw_2021_rkm_sf

```

### Chinook Salmon Juvenile Rearing, 2021

```{r chnk-juv-box-rkm-ms, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon juvenile rearing** across river kilometers in the **mainstem** Upper Walla Walla River, 2021."}
# Box-plot by rkm, Chinook juvenile rearing, Mainstem
chnk_juv_2021_rkm_ms = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_juv",
         str_starts(ID, "RKM"),
         str_ends(ID, "MS")) %>%
  ggplot(aes(x = Reach_ID_adjust, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_juv_2021_rkm_ms

```

```{r chnk-juv-box-rkm-nf, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon juvenile rearing** across river kilometers in the **North Fork** Walla Walla River, 2021."}
# Box-plot by rkm, Chinook spawning, North Fork
chnk_juv_2021_rkm_nf = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_juv",
         str_starts(ID, "RKM"),
         str_ends(ID, "NF")) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_juv_2021_rkm_nf

```

```{r chnk-juv-box-rkm-sf, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **Chinook salmon juvenile rearing** across river kilometers in the **South Fork** Walla Walla River, 2021."}
# Box-plot by rkm, Chinook spawning, South Fork
chnk_juv_2021_rkm_sf = hsi_raw %>%
  filter(year == "2021",
         scenario == "chnk_juv",
         str_starts(ID, "RKM"),
         str_ends(ID, "SF")) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
chnk_juv_2021_rkm_sf

```

### Steelhead Juvenile Rearing, 2021

```{r sthd-juv-box-rkm-ms, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **steelhead juvenile rearing** across river kilometers in the **mainstem** Upper Walla Walla River, 2021."}
# Box-plot by rkm, steelhead juvenile rearing, Mainstem
sthd_juv_2021_rkm_ms = hsi_raw %>%
  filter(year == "2021",
         scenario == "sthd_juv",
         str_starts(ID, "RKM"),
         str_ends(ID, "MS")) %>%
  ggplot(aes(x = Reach_ID_adjust, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
sthd_juv_2021_rkm_ms

```

```{r sthd-juv-box-rkm-nf, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **steelhead juvenile rearing** across river kilometers in the **North Fork** Walla Walla River, 2021."}
# Box-plot by rkm, steelhead juvenile rearing, North Fork
sthd_juv_2021_rkm_nf = hsi_raw %>%
  filter(year == "2021",
         scenario == "sthd_juv",
         str_starts(ID, "RKM"),
         str_ends(ID, "NF")) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
sthd_juv_2021_rkm_nf

```

```{r sthd-juv-box-rkm-sf, fig.cap = "Box plots showing the distribution of suitability values for composite, depth and velocity for **steelhead juvenile rearing** across river kilometers in the **South Fork** Walla Walla River, 2021."}
# Box-plot by rkm, steelhead juvenile rearing, South Fork
sthd_juv_2021_rkm_sf = hsi_raw %>%
  filter(year == "2021",
         scenario == "sthd_juv",
         str_starts(ID, "RKM"),
         str_ends(ID, "SF")) %>%
  ggplot(aes(x = ID, 
             y = value, 
             fill = metric)) +
  geom_boxplot() +
  facet_wrap(~ metric, nrow = 3) +
  theme_classic() +
  labs(x = "River Kilometer",
       y = "Suitability Index") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)))
sthd_juv_2021_rkm_sf

```

<!-- Below area all set to eval = F -->

```{r hhs-map-rkm, eval = F, results = 'hide', fig.cap = "Map showing the hydraulic habitat suitability by life stage and year for Chinook salmon and steelhead in the Upper Walla Walla watershed, plotted by river kilometer with geomorphic reaches also shown."}
# HHS map by scenario
scenario_labs = c("Chinook Juvenile", "Chinook Spawning", "Steelhead Juvenile")
names(scenario_labs) = c("chnk_juv", "chnk_spw", "sthd_juv")

# HHS maps
hhs_rkm = merge(rkm, hhs_rkm, by = "Reach_ID") %>%
ggplot() +
geom_sf(aes(fill = HHS)) +
scale_fill_distiller(palette = "Spectral",
                      direction = 1,
                      name = "Hydraulic Habitat Suitability (HHS)") +
  geom_sf(data = geo, color = 'grey50',
          fill = NA) +
  geom_sf_text(data = geo_ms, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = -4000,
                nudge_y = -1000) +
  geom_sf_text(data = geo_nf, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = 50,
                nudge_y = 2000) +
  geom_sf_text(data = geo_sf, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = 50,
                nudge_y = -3000) +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "top") +
  facet_grid(year ~ scenario, labeller = labeller(scenario = scenario_labs))
hhs_rkm

```

```{r depth-map-rkm, eval = F, results = 'hide', fig.cap = "Map showing the depth suitability by life stage and year for Chinook salmon and steelhead in the Upper Walla Walla River, plotted by river kilometer with geomorphic reaches also shown."}
# Depth maps
depth_rkm = merge(rkm, hhs_rkm, by = "Reach_ID") %>%
ggplot() +
geom_sf(aes(fill = d_HSI)) +
scale_fill_distiller(palette = "Spectral",
                      direction = 1,
                      name = "Depth Suitability") +
  geom_sf(data = geo, color = 'grey50',
          fill = NA) +
  geom_sf_text(data = geo_ms, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = -3000,
                nudge_y = -1000) +
  geom_sf_text(data = geo_nf, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = 50,
                nudge_y = 2000) +
  geom_sf_text(data = geo_sf, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = 50,
                nudge_y = -3000) +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "top") +
  facet_grid(year ~ scenario, labeller = labeller(scenario = scenario_labs))
depth_rkm

```

```{r vel-map-rkm, eval = F, results = 'hide', fig.cap = "Map showing the velocity (depth avg) suitability by life stage and year for Chinook salmon and steelhead in the Upper Walla Walla River, plotted by river kilometer with geomorphic reaches also shown."}
# Velocity maps
vel_rkm = merge(rkm, hhs_rkm, by = "Reach_ID") %>%
ggplot() +
geom_sf(aes(fill = v_HSI)) +
scale_fill_distiller(palette = "Spectral",
                      direction = 1,
                      name = "Velocity Suitability") +
  geom_sf(data = geo, color = 'grey50',
          fill = NA) +
  geom_sf_text(data = geo_ms, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = -3000,
                nudge_y = -1000) +
  geom_sf_text(data = geo_nf, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = 50,
                nudge_y = 2000) +
  geom_sf_text(data = geo_sf, aes(label = Reach),
                color = 'black',
                size = 2,
                nudge_x = 50,
                nudge_y = -3000) +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        legend.position = "top") +
  facet_grid(year ~ scenario,  labeller = labeller(scenario = scenario_labs))
vel_rkm

```
