---
title: "Summer Stream Temperature Assessment, Upper Walla Walla Watershed"
author:
  - Michael W. Ackerman:
      email: mike.ackerman@mthoodenvironmental.com
      institute: [mhe_mccall]
      correspondence: true
  - Bryce N. Oldemeyer:
      email: bryce.oldemeyer@mthoodenvironmental.com
      institute: [mhe_challis]
      correspondence: true
  - Mark Roes:
      email: mark.roes@mthoodenvironmental.com
      institute: [mhe_sandy]
      correspondence: false
institute:
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
  - mhe_challis: Mount Hood Environmental, PO Box 1303, Challis, Idaho 83226, USA
  - mhe_sandy: Mount Hood Environmental, 39085 Pioneer Boulevard \#100 Mezzanine, Sandy, Oregon, 97055, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/journal-of-archaeological-science.csl"
bibliography:
  - AckermanLibrary.bib
always_allow_html: yes
---

<!-- the following inserts MHE logo into header -->

```{=html}
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"logo.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>
```

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)

options(knitr.kable.NA = '--')

```

```{r load-libraries}
# run this if running chunks directly

# for formatting
library(kableExtra)
library(ggpubr)

# for analysis
library(sf)
library(here)
library(tidyverse)
library(magrittr)
library(ggmap)
library(nngeo)
library(janitor)

theme_set(theme_pubr(x.text.angle = 45,
                     base_size = 8))

```

```{r load-data}
# Project area polygons and 200m layer (with habitat attributes) within project area
load(here("analysis/data/derived_data/uww_spatial.rda"))

```


# Background

Water is the cornerstone of First Foods production and inherently tied to the five fundamental touchstones: hydrology, geomorphology, habitat and network connectivity, riverine biotic community, and riparian vegetation [@Jones2008]. These touchstones form the Umatilla River Vision, a holistic approach to water quality restoration. Stream water temperature is a critical component of the hydrology of the Upper Walla Walla watershed directly affecting the fish community and the connectivity of their habitat. <!-- add a bit more context to lead into the temp assessment -->


## Objectives

The primary objectives of the Upper Walla Walla summer stream temperature assessment is to:

1. Summarize contemporary composite and future projected summer stream temperature scenarios for the Upper Walla Walla available from the NorWeST dataset [Isaak2017a].
2. Compare current and projected summer stream temperature scenarios in the Upper Walla Walla to life-stage specific temperature thresholds for Chinook salmon and steelhead [@Carter2005] to evaluate whether temperatures may hinder summer life-stages of those species.
3. Evaluate a hypothetical scenario where restoration efforts (e.g., riparian planting, improved grazing practices) over the next \~60 years decrease summer stream temperatures relative to current temperatures by -1^o^ C.


# Assessment Approach

We used a combination of modeled NorWeST summer stream temperature predictions [@Isaak2017a] for the Upper Walla Walla River watershed plus life-stage specific temperature thresholds (Table \@ref(tab:temp-thresh)) [@Carter2005] to evaluate whether current or future project summer stream temperatures might hinder the ability of the target species to use available habitat during summer months. To accomplish this, we calculated whether recent and projected August mean stream temperatures exceeded the optimum range (Table \@ref(tab:temp-thresh)) for life-stages present during summer months for the target species.


## Target Species

The focal species for the summer stream temperature assessment include:

* Spring-run Chinook salmon (*Oncorhynchus tshawytscha*; hereafter Chinook salmon)
* Middle Columbia River summer steelhead (*O. mykiss*; hereafter steelhead; ESA-listed threatened)
<!--
* Columbia River bull trout (*Salvelinus confluentus*; ESA-listed threatened)
* Pacific lamprey (*Lampetra tridentata*)
-->


## Study Area

This summer stream temperature assessment will be focused on the upper Walla Walla River from the confluence with Dry Creek near Lowden, Washington, to the headwaters of the North and South forks of the Walla Walla River and include streams and tributaries modeled as part of the NorWeST dataset [@Isaak2017a].


## Summer Stream Temperature Data

Three NorWeST temperature scenarios were considered:

* **Historic Composite** (S2_02_11): A historical composite scenario representing the 10-year average August mean stream temperatures for 2002-2011.

* **2040 Projected** (S30_2040D): A future August mean stream temperature scenario based on global ensemble average projected changes in August air temperature and stream discharge for A1B warming trajectory in the 2040s (2030-2059). Future stream deltas within a NorWeST unit account for differential sensitivity among streams so that cold stream warm less than warm streams.

* **2080 Projected** (S32_2080D): A future August mean stream temperature scenario based on global ensemble average project changes in August air temperature and stream discharge for A1B warming trajectory in the 2080s (2070-2099). Future stream deltas within a NorWeST unit account for differential sensitivity among streams so that cold streams warm less than warm streams.

```{r norwest, fig.cap = "Recent mean (2002-2011) and projected (2040 and 2080) August mean stream temperature scenarios available from NorWeST (Isaak et al. 2017) for the Upper Walla Walla watershed."}
river_color = "lightskyblue1"
norwest_df = uww_rch_sf %>%
  select(S2_02_11,
         S30_2040D,
         S32_2080D) %>%
  mutate(S2_02_11 = replace(S2_02_11, S2_02_11 == -9999.00, NA),
         S30_2040D = replace(S30_2040D, S30_2040D == -9999.00, NA),
         S32_2080D = replace(S32_2080D, S32_2080D == -9999.00, NA)) %>%
  rename(`Recent Mean` = S2_02_11,
         `2040 Projected` = S30_2040D,
         `2080 Projected` = S32_2080D) %>%
  pivot_longer(cols = c("Recent Mean",
                        "2040 Projected",
                        "2080 Projected"),
               names_to = "scenario",
               values_to = "temp_c")
  # pivot_longer(cols = c("S2_02_11",
  #                       "S30_2040D",
  #                       "S32_2080D"),
  #              names_to = "scenario",
  #              values_to = "temp_c")

norwest_p = norwest_df %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = norwest_df,
          aes(color = temp_c),
          size = 1) +
  scale_color_viridis_c(option = "turbo") +
  facet_wrap(~ scenario,
             ncol = 2) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "NorWeST Summer Stream Temperatures",
       color = expression("Temperature ("^o*"C)"))
norwest_p

```

```{r norwest-bp, fig.cap = "Boxplot showing distributions of recent mean (2002-2011) and projected (2040 and 2080) August mean stream temperatures from NorWeST (Isaak et al. 2017) for the Upper Walla Walla watershed."}
norwest_bp = norwest_df %>%
  ggplot() +
  geom_boxplot(aes(x = scenario,
                   y = temp_c),
               fill = "gray50") +
  theme_bw()
norwest_bp

```


## Fish Temperature Threshholds

For Chinook salmon, we considered the spawning and summer parr life-stages, and for steelhead, the summer parr life-stage was considered (Figure \@ref(fig:thresh-map)).

```{r temp-thresh}
temp_thresh_tab = tibble(Species = c("Chinook", "Chinook", "Steelhead"),
                         `Life Stage` = c("Spawning", "Summer Rearing", "Summer Rearing"),
                         Timing = c("8/10 - 9/30", "6/10 - 10/15", "6/10 - 10/15"),
                         Minimum = c("3.3", "4.5", "4.5"),
                         Optimum = c("7.2 - 14.5", "10 - 16", "10 - 18"),
                         Maximum = c("18", "20", "19"),
                         Acute = c("20", "22", "22")) %>%
  kable(booktabs = T,
        align = "ccccccc",
        caption = "Life stage timing, and minimum, optimum, maximum, and acute temperature (Celcius) threshholds for summer life-stages of Chinook salmon and steelhead, adopted from Carter (2005). All temperatures are expressed as the 7-day Maximum Weekly Maximum Temperature (MWMT).") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))
temp_thresh_tab

```


# Results

## Stream Temperature Suitability

```{r thresh-map, out.width = "100%", fig.cap = "Maps depicting whether recent mean (2002-2011) and projected (2040 and 2080) August mean stream temperatures exceed (TRUE) or are below (FALSE) the optimal range for summer life-stages of Chinook salmon and steelhead and within the Upper Walla Walla watershed."}
thresh_df = norwest_df %>%
  mutate(`Chinook Spawning` = ifelse(temp_c > 14.5, T, F),
         `Chinook Parr` = ifelse(temp_c > 16, T, F),
         `Steelhead Parr` = ifelse(temp_c > 18, T, F)) %>%
  pivot_longer(cols = c("Chinook Spawning",
                        "Chinook Parr",
                        "Steelhead Parr"),
               names_to = "spec_ls",
               values_to = "above_optimum") %>%
  mutate(above_optimum = replace_na(above_optimum, F)) %>%
  # get reach length
  st_join(uww_rch_sf %>%
            select(geometry,
                   reach_leng))

thresh_p = thresh_df %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union(),
          fill = NA,
          color = "gray50") +
  #geom_sf(color = river_color) +
  geom_sf(data = thresh_df,
          aes(color = above_optimum),
          size = 1) +
  scale_color_manual(values = c("FALSE" = river_color,
                                "TRUE" = "red")) +
  facet_grid(spec_ls ~ scenario) +
  theme_bw() +
  theme(legend.position = "top",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(color = "Above Optimum Temperature")
thresh_p

```


## Habitat Capacity Results

Describe changes in QRF relative habitat capacities using the 2040, 2080, and -1 scenarios using the RF extrapolation model. Do we see decreases in capacity under projected climate change scenarios? Alternatively, could some habitat capacity limitations be rectified through rehabilitation actions to cool stream temperatures by 1C.
<!--
* Re-run the RF extrapolations for the UWW also using the 2040, 2080, and -1 scenarios.
* Compare relative changes in capacity for those scenarios relative to the Recent Mean scenario
-->


# Discussion

Discussion text...


# Literature Cited

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>


<!-- misc deprecated code and figures 
```{r current_temp_map}

river_color = "lightskyblue1"

# Current temp map
temp_map_cur = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S2_02_11 = replace(S2_02_11, S2_02_11 == -9999.00, NA)),
          aes(color = S2_02_11),
          size = 1) +
  scale_color_viridis_c(direction = 1, limits = c(5,25)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "2002-2011 historical composite scenario",
       color = expression("Temperature ("^o*"C)"))

# 2040 temp map
temp_map_2040 = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S30_2040D = replace(S30_2040D, S30_2040D == -9999.00, NA)),
          aes(color = S30_2040D),
          size = 1) +
  scale_color_viridis_c(direction = 1, limits = c(5,25)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "2040 future scenario",
       color = expression("Temperature ("^o*"C)"))

# 2080 temp map
temp_map_2080 = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S32_2080D = replace(S32_2080D, S32_2080D == -9999.00, NA)),
          aes(color = S32_2080D),
          size = 1) +
  scale_color_viridis_c(direction = 1, limits = c(5,25)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "2080 future scenario",
       color = expression("Temperature ("^o*"C)"))

# -1C results
temp_map_1C = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S2_02_11 = replace(S2_02_11, S2_02_11 == -9999.00, NA)),
          aes(color = (S2_02_11-1)),
          size = 1) +
  scale_color_viridis_c(direction = 1, limits = c(5,25)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = expression("Hypothetical restoration effect on \n historic composite scenario (-1"^o*"C)"),
       color = expression("Temperature ("^o*"C)"))


# 2040 comparison
temp_rel_map_2040 = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S30_2040D = replace(S30_2040D, S30_2040D == -9999.00, NA),
                   S2_02_11 = replace(S2_02_11, S2_02_11 == -9999.00, NA),
                   temp_dif = S30_2040D - S2_02_11),
          aes(color = temp_dif),
          size = 1) +
  scale_color_viridis_c(direction = 1,limits = c(-1,2.5)) +
#scale_fill_gradientn(limits = c(1,3)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "2040 future scenario",
       color = expression("Temperature ("^o*"C)"))

# 2080 comparison
temp_rel_map_2080 = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S32_2080D = replace(S32_2080D, S32_2080D == -9999.00, NA),
                   S2_02_11 = replace(S2_02_11, S2_02_11 == -9999.00, NA),
                   temp_dif = S32_2080D - S2_02_11),
          aes(color = temp_dif),
          size = 1) +
  scale_color_viridis_c(direction = 1,limits = c(-1,2.5)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "2080 future scenario",
       color = expression("Temperature ("^o*"C)"))


# -1C results
temp_rel_map_1C = uww_rch_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_rch_sf %>%
            mutate(S2_02_11 = replace(S2_02_11, S2_02_11 == -9999.00, NA)),
          aes(color = (S2_02_11-1)),
          size = 1) +
  scale_color_viridis_c(direction = 1,limits = c(-1,2.5)) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = expression("Hypothetical restoration effect on \n historic composite scenario (-1"^o*"C)"),
       color = expression("Temperature ("^o*"C)"))

```

```{r current-temp-maps, fig.cap = "NorWeST average August mean stream temperatures for the Upper Walla Walla."}

temp_map_cur

```

```{r 2040-temp-maps, fig.cap = "NorWeST average August mean stream temperatures for the Upper Walla Walla."}

temp_map_2040

```

```{r 2080-temp-maps, fig.cap = "NorWeST average August mean stream temperatures for the Upper Walla Walla."}

temp_map_2080

```

```{r 1C-temp-maps, fig.cap = "NorWeST average August mean stream temperatures for the Upper Walla Walla."}
temp_map_1C

```

```{r 2040-temp-comparison-maps, fig.cap = "Difference in projected NorWeST average August mean stream temperatures for 2040relative to the 2002-2011 historical composite scanerio for the Upper Walla Walla."}

ggarrange(temp_rel_map_2040)

```

```{r 2080-temp-comparison-maps, fig.cap = "Difference in projected NorWeST average August mean stream temperatures for 2080 relative to the 2002-2011 historical composite scanerio for the Upper Walla Walla."}

ggarrange(temp_rel_map_2080)

```

```{r 1C-temp-comparison-maps, fig.cap = "Difference in projected NorWeST average August mean stream temperatures for - 1oC scenario relative to the 2002-2011 historical composite scanerio for the Upper Walla Walla."}

ggarrange(temp_rel_map_1C)

```
-->
