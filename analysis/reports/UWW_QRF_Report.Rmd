---
title: "Upper Walla Walla Watershed - Habitat Capacity Assessment"
author:
  - Michael W. Ackerman:
      email: mike.ackerman@mthoodenvironmental.com
      institute: [mhe_mccall]
      correspondence: true
  - Tara E. Blackman:
      email: tara.blackman@mthoodenvironmenal.com
      institute: [mhe_sandy]
      correspondence: false
  - Mark Roes:
      email: mark.roes@mthoodenvironmental.com
      institute: [mhe_sandy]
      correspondence: false
  - Kevin E. See:
      email: Kevin.See@dfw.wa.gov
      institute: wdfw
      correspondence: false
institute:
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
  - mhe_sandy: Mount Hood Environmental, 39085 Pioneer Boulevard \#100 Mezzanine, Sandy, Oregon, 97055, USA
  - wdfw: Washington Department of Fish and Wildife, Fish Program, Science Division, 1111 Washington Street NE, Olympia, Washington, 98501, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/american-fisheries-society.csl"
bibliography:
  - AckermanLibrary.bib
---

<!-- the following inserts MHE logo into header -->
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"logo.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)

options(knitr.kable.NA = '--')

```

```{r load-libraries}
# run this if running chunks directly

# for formatting
library(kableExtra)
library(ggpubr)

# for analysis
library(sf)
library(here)
library(tidyverse)
library(magrittr)
library(ggmap)
library(nngeo)
library(janitor)

theme_set(theme_pubr(x.text.angle = 45,
                     base_size = 8))

```


# Background

Water is the cornerstone of First Food production and inherently tied to the five fundamental touchstones: hydrology, geomorphology, habitat and network connectivity, riverine biotic community, and riparian vegetation [@Jones2008]. The Umatilla River Vision defines a holistic approach to the restoration of water quality and the implications thereof. Population status and habitat use of riverine fishes defined as First Food (including Endangered Species Act [ESA] listed middle Columbia River summer-run steelhead, spring-run Chinook salmon, bull trout, and Pacific lamprey) are identified as critical data needs in the assessment of biotic communities [@Jones2008]. The decline of anadromous Pacific salmonids (*Oncorhynchus* spp.) across the Pacific Northwest, USA, has prompted numerous actions aimed at reversing that trend. These actions are often categorized into four ‘H’s’ - harvest modification, habitat rehabilitation, hydroelectric operations, and hatchery practices. Problematically, substantial uncertainty remains regarding the degree of change to salmon populations that can be exerted across and within these categories, and what combination of changes might most cost-effectively and sustainably reduce mortality and recover depleted populations. Recovery plans (e.g., @NOAA2009) have identified adult escapement targets at the population scale, providing a quantitative metric useful for evaluating the magnitude of survival improvements (across life-stages) required. These abundance targets provide a benchmark against which habitat rehabilitation actions can be measured. Here, we apply a novel approach to estimating life-stage specific habitat capacity for spring-run Chinook salmon (hereafter Chinook salmon) and summer-run steelhead (hereafter steelhead) that can be used to quantitatively estimate the magnitude of tributary habitat restoration needed to achieve recovery goals in the Upper Walla Walla watershed. The necessity of tributary habitat restoration actions can now be demonstrated, and the magnitude of required change can be placed in context with the other ‘H’s’.


## Focal Species

The focal species for the QRF habitat capacity assessment are:

* Spring-run Chinook salmon (*Oncorhynchus tshawytscha*; hereafter Chinook salmon)
* Middle Columbia River summer steelhead (*O. mykiss*; hereafter steelhead; ESA-listed threatened)

While our habitat capacity models specifically address Chinook salmon and steelhead, any uplift in habitat for these species are expected to also uplift:

* Columbia River bull trout (*Salvelinus confluentus*; ESA-listed threatened)
* Pacific lamprey (*Lampetra tridentata*)


## Study Area

This assessment will be focused on the alluvial channel of the Walla Walla River from the confluence with Dry Creek near Lowden, Washington, to the headwaters of the North and South forks of the Walla Walla River. The primary study area includes approximately 70 miles of stream. The secondary study area includes the catchment of the primary study area which encompasses approximately 885 square miles.


# Biological Assessment

* What is currently known about fish use in the Upper Walla Walla watershed?
  * Focus is Chinook salmon and steelhead, but also provide information on bull trout and lamprey.
  * Other species of concern? Other predators or non-native of concern?
* Are there currently identified limiting factors for focal species?
* Could potentially include a literature review of both documents and datasets; what datasets do we find most relevant?


# Habitat Capacity Assessment

```{r load-data}
# Upper Walla Walla QRF extrapolations
load(here("analysis/data/derived_data/uww_qrf_extrapolations.rda"))

# Project area polygons and 200m layer (with habitat attributes) within project area
load(here("analysis/data/derived_data/uww_spatial.rda"))

# convert sf objects to tibbles
uww_sum_df = uww_sum_sf %>%
  st_drop_geometry() %>%
  as_tibble()

uww_win_df = uww_win_sf %>%
  st_drop_geometry() %>%
  as_tibble()

uww_redd_df = uww_redd_sf %>%
  st_drop_geometry() %>%
  as_tibble()

```


## Approach

The habitat capacity assessment focuses on Chinook salmon and steelhead. Habitat capacity deficits (Figure \@ref(fig:capacity-schematic) due to potential limitations in habitat quantity and quality were assessed at three life stages for both Chinook salmon and steelhead: spawning (redd) capacity, and juvenile rearing capacity during both summer and winter months. First, life-stage-specific capacity required to support adult abundance to achieve recovery goals was estimated using a Generalized Capacity Model (Appendix C in @IdahoOSCTeam2019). Following, we estimate currently available redd and juvenile rearing capacity using a quantile random forest (QRF) approach [@See2021]. Life-stage-specific required capacities were then compared to available capacity to identify capacity deficits for Chinook salmon and steelhead.

```{r capacity-schematic, out.width = "100%", fig.cap = "Schematic depicting an ideal scenario on the left with no limiting factors, while the right depicts a river with significant limiting factors resulting in less habitat capacity and less production."}
knitr::include_graphics("../figures/hab-capac-fig.png")

```


## Required Capacity

```{r get-params}
params = read_csv(here("analysis/data/raw_data/LifeHistoryParameters.csv"))

rec_goals = tibble(Species = c("Chinook", "Steelhead"),
                   Scenario = "CBPTF 2020",
                   Escapement = c(3600, 3400)) %>%
  inner_join(params %>%
               mutate(Parameter = recode(Parameter,
                                         "Female Ratio" = "prop_fem",
                                         "Redds/Female" = "redd_per_fem",
                                         "Fecundity" = "fecund",
                                         "Egg:Parr" = "egg_to_parr",
                                         "Parr:Presmolt" = "parr_to_presmolt")) %>%
               pivot_wider(id_cols = "Species",
                           names_from = "Parameter",
                           values_from = "Value")) %>%
  mutate(`Female Escapement` = Escapement * prop_fem,
         Redds = `Female Escapement` * redd_per_fem,
         Eggs = Redds * fecund,
         `Summer Juveniles` = Eggs * egg_to_parr,
         `Winter Juveniles` = `Summer Juveniles` * parr_to_presmolt) %>%
  select(-c(prop_fem:parr_to_presmolt)) %>%
  pivot_longer(cols = c(Escapement, `Female Escapement`:`Winter Juveniles`),
               names_to = "LifeStage",
               values_to = "Abundance")

```

Life-stage-specific capacity requirement were estimates using a Generalized Capacity Model described in Appendix C of @IdahoOSCTeam2019 which uses a combination of empirical and literature-based parameter estimates (Table \@ref(tab:param-tab)) to determine capacity necessary to achieve a given adult abundance goal. We used adult escapement goals of `r prettyNum(rec_goals$Abundance[rec_goals$Species == "Chinook" & rec_goals$LifeStage == "Escapement"], big.mark = ",")` for Chinook salmon and `r prettyNum(rec_goals$Abundance[rec_goals$Species == "Steelhead" & rec_goals$LifeStage == "Escapement"], big.mark = ",")` for steelhead. These escapement goals are considered high-range goals and are intended to represent *"healthy and harvestable abundance levels that would sustain very high levels of species viability, significant fishery opportunities and harvest, and a fuller range of ecological values"* [@CBPTF2020]. Briefly, these adult escapement goals are multiplied step-wise by parameter values in Table \@ref(tab:param-tab) to determine the abundance for a given life-stage necessary to support that adult abundance. As an example, the adult escapement goal is multiplied by an estimate of the proportion of female in the population and an estimate of the redds per female to determine the number of redds necessary for recovery. Sources for each of the parameter estimates are provided in Table \@ref(tab:param-tab); however, those values can be modified if e.g., more up-to-date or local estimates are available and justifiable.

```{r param-tab}
params %>%
  kable(booktabs = T,
        digits = 3,
        align = "lccc",
        format.args = list(big.mark = ",",
                           drop0trailing = T),
        caption = "Life history parameters for the generalized capacity model.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

The resulting estimates of habitat capacity requirements are shown in Table \@ref(tab:require-tab) and represent the required number of a given life-stage that are necessary to achieve target adult escapement goals.

```{r require-tab}
rec_goals %>%
  kable(booktabs = T,
        digits = 0,
        align = "cccc",
        format.args = list(big.mark = ",",
                           drop0trailing = T),
        caption = "Life-stage specific habitat capacity requirement estimates necessary to achieve given escapement recovery goals.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```


## Available Capacity

Available capacity estimates were generated following a quantile random forest (QRF) framework [@See2021]. The QRF approach enables spatially continuous estimates of available habitat capacity given existing conditions and for key life-stages of Chinook salmon and steelhead. Currently, available QRF models allow evaluation of three anadromous life stages: 1) spawning capacity (the number of redds that can be supported), 2) summer juvenile rearing (the number of parr that can be supported during low-flow summer months), and 3) winter juvenile rearing capacity (the number of presmolts that can be supported through winter months). The QRF models to estimate available habitat capacity, including data inputs, are described in further detail in Appendix B of @IdahoOSCTeam2019.


### QRF Model

We define habitat (carrying) capacity as the maximal abundance or load the habitat can support for a given species and life stage given current resources and habitat quantity and quality. Within fisheries research and management, it has been recognized that biotic and abiotic factors limit productivity within and across life-stages. However, we assume that observed fish density is a poor predictor of habitat capacity due to both a paucity of individuals (e.g., low spawner abundance) and the existence of unmeasured biotic or abiotic variables that may limit capacity. To address this, @See2021 developed a novel approach to estimate the carrying capacity of wadable streams to support spawning and rearing Chinook salmon and steelhead. The approach involves fitting a QRF [@Meinshausen2006; @Cade2003] model to paired fish and habitat data across hundreds of sites in seven watersheds within the Columbia River Basin. Habitat data from the Colmbia Habitat Monitoring Program (CHaMP) were paired to juvenile fish and redd survey data to develop fish-habitat relationships [@See2021]. Importantly, the QRF model places no constraints on possible fish-habitat relationships; instead, relationships are estimated from the empirical data regardless of being positive, negative, linear, non-linear, etc. Based on the observed fish-habitat relationships, we can then predict habitat capacity at any location using measurements of the same habitat covariates used to populate the model (e.g., at all CHaMP sites) (Table \@ref(tab:cov-tab)). The random forest model produces a distribution of predictions, one for each tree in the forest, and we chose the 90th quantile of that distribution as a proxy for carrying capacity.

```{r cov-tab}
load(here("analysis/data/derived_data/hab_cov_tbl.rda"))

hab_cov_tbl %>%
  select(-Covariate) %>%
  kable(booktabs = T,
        align = "ccccccccl",
        caption = "Habitat covariates and their descriptions used in each of the QRF capacity models. Numbers indicate where each metric ranked in relative importance for each model. Dots indicate a metric was not used for a given model.") %>%
  kable_styling(position = "center",
                bootstrap_options = c("striped", "condensed"))

```


### Extrapolation Model

Although we have hundreds of sites across the Columbia River basin with detailed habitat data, and therefore QRF predictions of capacity at those sites, that really only covers a small percentage of the anadromous zone, evein within watersheds with those sites. And many watershed, including the Walla Walla, contain no sites whatsoever.<!--I need to verify that statement, there may be a small number of CHaMP sites in the Walla Walla, but I believe, not--> Therefore, to extrapolate our capacity predictions at CHaMP sites to other areas, we used a [stream layer](https://www.nwfsc.noaa.gov/research/datatech/data/col_basin_hist_project/index.cfm) available from NOAA fisheries. This layer consists of a polyline shapefile divided into 200m reaches with various attributes attached to each reach. We refer to these as globally available attributes (GAAs) because they are associated with every reach across all watersheds in the Columbia River Basin. The file is derived  from the [National Hydrography Dataset High Resolution](https://www.usgs.gov/core-science-systems/ngp/national-hydrography/nhdplus-high-resolution) (NHDPlus HR) dataset, which has a high resolution, 1:24,000. Here, we used GAA data available for the Upper Walla Walla River watershed to estimate capacity at the watershed scale.

We fit an extrapolation model using the predicted capacity (in either linear or areal density) as the response, and various GAAs as the covariates. The extrapolation model was also a random forest model; the nature of the random forest models allows for non-linear associations between capacity and some GAAs, while also preventing the extrapolation from growing beyond the largest predicted capacities in our initial dataset. We calculated the standard error of our predictions by the standard deviation of the random forest predicted distribution at each reach. The capacity of each 200m reach is calculated by multiplying the predicted fish/m capacity by the length of that reach. To determine the total capacity for a specified region, the capacities of each reach within that region are summed.

```{r gaa-tbl}
load(here("analysis/data/derived_data/extrap_gaa_tbl.rda"))

gaa_tbl %>%
  kable(booktabs = T,
        align = "cl",
        caption = "Habitat covariates and their descriptions used in the random forest extrapolation model.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```


### QRF Capacity Estimates

```{r calc-chnk-capacity}
source(here("R/calc_watershed_cap.R"))

# Chinook salmon, summer parr
chnk_sum_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_sum_sf,
                                  capacity_name = "chnk_per_m",
                                  capacity_se_name = "chnk_per_m_se",
                                  by_stream = T)

# Chinook salmon, winter presmolt
chnk_win_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_win_sf,
                                  capacity_name = "chnk_per_m",
                                  capacity_se_name = "chnk_per_m_se",
                                  by_stream = T)

# Chinook salmon, redds
chnk_redd_cap = calc_watershed_cap(uww_huc_sf,
                                   uww_redd_sf,
                                   capacity_name = "chnk_per_m",
                                   capacity_se_name = "chnk_per_m_se",
                                   by_stream = T)

```

```{r calc-sthd-capacity}
# steelhead, summer parr
sthd_sum_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_sum_sf,
                                  capacity_name = "sthd_per_m",
                                  capacity_se_name = "sthd_per_m_se",
                                  by_stream = T)

# steelhead, winter presmolt
sthd_win_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_win_sf,
                                  capacity_name = "sthd_per_m",
                                  capacity_se_name = "sthd_per_m_se",
                                  by_stream = T)

# steelhead, redds
sthd_redd_cap = calc_watershed_cap(uww_huc_sf,
                                   uww_redd_sf,
                                   capacity_name = "sthd_per_m",
                                   capacity_se_name = "sthd_per_m_se",
                                   by_stream = T)

```

```{r compile-capacity}
cap_totals = list(chnk_sum = chnk_sum_cap,
                  chnk_win = chnk_win_cap,
                  chnk_redd = chnk_redd_cap,
                  sthd_sum = sthd_sum_cap,
                  sthd_win = sthd_win_cap,
                  sthd_redd = sthd_redd_cap) %>%
  map_df(.id = "type",
        .f = function(x) {
          x %>%
            filter(StreamName == "Total")
        }) %>%
  mutate(Species = str_split(type, "_", simplify = T)[ ,1],
         LifeStage = str_split(type, "_", simplify = T)[ ,2]) %>%
  mutate(Species = recode(Species,
                          "chnk" = "Chinook",
                          "sthd" = "Steelhead"),
         LifeStage = recode(LifeStage,
                            "sum" = "Summer Juveniles",
                            "win" = "Winter Juveniles",
                            "redd" = "Redds")) %>%
  select(Species,
         LifeStage,
         everything(),
         -StreamName,
         -type)

```

Estimates of total habitat capacity for the Upper Walla Walla, by species and life-stage, are shown in Table \@ref(tab:cap-table). Currently, estimates are made using the anadromous, spatial domain defined in [StreamNet](https://www.streamnet.org/home/data-maps/gis-data-sets/) for Chinook salmon and steelhead. Using those domains capacity extrapolations were made for `r unique(cap_totals$n_rchs[cap_totals$Species == "Chinook"])` reaches totaling `r round(unique(cap_totals$tot_length[cap_totals$Species == "Chinook"]) / 1000)` km in length for Chinook salmon and `r prettyNum(unique(cap_totals$n_rchs[cap_totals$Species == "Steelhead"]), big.mark = ",")` reaches totaling `r round(unique(cap_totals$tot_length[cap_totals$Species == "Steelhead"]) / 1000)` km in length for steelhead. Different spatial domains could be used for both Chinook salmon and steelhead if deemed appropriate. Capacity estimates for individual streams within the modeled spatial domains, by species and life stage, are provided in the [Supplemental Tables and Figures](#supplemental-tables-and-figures) section. 

```{r cap-table}
cap_totals %>%
  mutate(avg_cap_per_m = tot_cap / tot_length) %>%
  mutate(tot_length_km = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length_km,
         Capacity = tot_cap,
         SE = tot_cap_se,
         `Avg. Capacity / m` = avg_cap_per_m) %>%
  select(Species,
         LifeStage,
         `n Reaches`,
         `Stream Length (km)`,
         Capacity,
         SE,
         `Avg. Capacity / m`) %>%
  kable(booktabs = T,
        digits = c(0, 0, 1, 0, 0, 0, 3),
        align = "ccccccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of current available watershed capacity by species and life-stage.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

Maps depicting capacity extrapolations can be useful to visualize low- versus high-capacity areas, which can be useful for prioritization efforts. These extrapolations, by species and life-stage, have been exported in geopackage file format and are available in the [UWW.plan GitHub repository](https://github.com/Mount-Hood-Environmental/UWW.plan). Chinook salmon and steelhead capacity extrapolations are shown in Figures \@ref(fig:chnk-maps) and \@ref(fig:sthd-maps), respectively.

```{r create-chnk-maps}
# pick a background river color
river_color = "lightskyblue1"

# chinook summer parr
chnk_sum_map = uww_sum_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_sum_sf %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  labs(title = "Chinook, Summer Juveniles",
       color = expression(`Summer Juv` / m^2))

# chinook winter presmolts
chnk_win_map = uww_win_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_win_sf %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  labs(title = "Chinook, Winter Juveniles",
       color = expression(`Winter Juv` / m^2))

# chinook redds
chnk_redd_map = uww_redd_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_redd_sf %>%
            filter(chnk) %>%
            mutate(chnk_per_km = chnk_per_m * 1000),
          aes(color = chnk_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  labs(title = "Chinook, Redds",
       color = expression(Redds / km))
    

```

```{r create-sthd-maps}
# steelhead summer juveniles
sthd_sum_map = uww_sum_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_sum_sf %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  labs(title = "Steelhead, Summer Juveniles",
       color = expression(`Summer Juv` / m^2))

# steelhead winter juveniles
sthd_win_map = uww_win_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_win_sf %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  labs(title = "Steelhead, Winter Juveniles",
       color = expression(`Winter Juv` / m^2))

# steelhead redds
sthd_redd_map = uww_redd_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_redd_sf %>%
            filter(sthd) %>%
            mutate(sthd_per_km = sthd_per_m * 1000),
          aes(color = sthd_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) +
  labs(title = "Steelhead, Redds",
       color = expression(Redds / km))

```

```{r chnk-maps, fig.cap = "Extrapolations of habitat capacity for Chinook salmon, by life-stage, within the Upper Walla Walla watershed."}
ggarrange(chnk_sum_map,
          chnk_win_map,
          chnk_redd_map)

```

```{r sthd-maps, fig.cap = "Extrapolations of habitat capacity for steelhead, by life-stage, within the Upper Walla Walla watershed."}
ggarrange(sthd_sum_map,
          sthd_win_map,
          sthd_redd_map)

```


## Capacity Limitations

Finally, habitat capacity deficits (limitations) can be estimated as the required capacity minus the available capacity (Table \@ref(tab:cap-limits)). We estimated capacity deficits, including relative deficits, for the Upper Walla Walla watershed to identify potential species and life-stage limitations in physical habitat quantity and/or quality. Table \@ref(tab:cap-limits) also shows relative deficits that provide guidance on species and life-stages where rehabilitation efforts could be targeted.

```{r cap-limits}
rec_goals %>%
  left_join(cap_totals %>%
              select(-n_rchs,
                     -tot_length)) %>%
  mutate(Deficit = Abundance - tot_cap,
         `Relative Deficit` = Deficit / tot_cap) %>%
  rename(`Required Capacity` = Abundance,
         `Available Capacity` = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,0,0,0,0,0,2),
        align = "cccccccc",
        format.args = list(big.mark = ","),
        caption = "Capacity deficits and relative deficits based on recovery goals.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

Comparisons of available and required capacity for life-stages that QRF models are available are shown in Figures \@ref(fig:chnk-def-fig) and \@ref(fig:chnk-def-fig). Cases where the required capacity exceeds available capacity represents a capacity deficit.

```{r chnk-def-fig, fig.cap = "Estimates of available capacity given current habitat conditions for Chinook salmon in the Upper Walla Walla watershed, made using a quantile random forest (QRF) approach versus the capacity required to support recovery goals."}
chnk_def_p = rec_goals %>%
  select(-Scenario) %>%
  filter(Species == "Chinook",
         LifeStage %in% c("Redds",
                          "Summer Juveniles",
                          "Winter Juveniles")) %>%
  left_join(cap_totals %>%
              select(-n_rchs,
                     -tot_length)) %>%
  select(!Species) %>%
  rename(Required = Abundance,
         Available = tot_cap,
         se = tot_cap_se) %>%
  pivot_longer(cols = c("Required",
                        "Available")) %>%
  mutate(se = ifelse(name == "Required", NA, se)) %>%
  select(LifeStage, name, value, se) %>%
  ggplot() +
  geom_bar(aes(x = name,
               y = value,
               fill = name),
           color = "black",
           stat = "identity") +
  scale_x_discrete(limits = rev) +
  scale_fill_manual(name = "Capacity",
                    values = c("gray30", "forestgreen")) +
  coord_flip() +
  facet_wrap(~ LifeStage,
             scales = "free",
             ncol = 1,
             strip.position = "left",
             labeller = labeller(LifeStage = label_wrap_gen(width = 10))) +
  geom_errorbar(aes(x = name,
                    ymin = value - 1.96 * se,
                    ymax = value + 1.96 * se),
                width = 0,
                size = 0.5) +
  scale_y_continuous(labels = scales::comma,
                     expand = c(0,0)) +
  labs(title = "Chinook salmon") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 8,
                                   color = "black"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        strip.text.y = element_text(size = 10),
        plot.title = element_text(size = 12,
                                  face = "bold"),
        legend.position = "right")

chnk_def_p

```

```{r sthd-def-fig, fig.cap = "Estimates of available capacity given current habitat conditions for Steelhead in the Upper Walla Walla watershed, made using a quantile random forest (QRF) approach versus the capacity required to support recovery goals."}
sthd_def_p = rec_goals %>%
  select(-Scenario) %>%
  filter(Species == "Steelhead",
         LifeStage %in% c("Redds",
                          "Summer Juveniles",
                          "Winter Juveniles")) %>%
  left_join(cap_totals %>%
              select(-n_rchs,
                     -tot_length)) %>%
  select(!Species) %>%
  rename(Required = Abundance,
         Available = tot_cap,
         se = tot_cap_se) %>%
  pivot_longer(cols = c("Required",
                        "Available")) %>%
  mutate(se = ifelse(name == "Required", NA, se)) %>%
  select(LifeStage, name, value, se) %>%
  ggplot() +
  geom_bar(aes(x = name,
               y = value,
               fill = name),
           color = "black",
           stat = "identity") +
  scale_x_discrete(limits = rev) +
  scale_fill_manual(name = "Capacity",
                    values = c("gray30", "dodgerblue3")) +
  coord_flip() +
  facet_wrap(~ LifeStage,
             scales = "free",
             ncol = 1,
             strip.position = "left",
             labeller = labeller(LifeStage = label_wrap_gen(width = 10))) +
  geom_errorbar(aes(x = name,
                    ymin = value - 1.96 * se,
                    ymax = value + 1.96 * se),
                width = 0,
                size = 0.8) +
  scale_y_continuous(labels = scales::comma,
                     expand = c(0,0)) +
  labs(title = "Steelhead") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 8,
                                   color = "black"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        strip.text.y = element_text(size = 10),
        plot.title = element_text(size = 12,
                                  face = "bold"),
        legend.position = "right")

sthd_def_p

```


## Further Considerations

Things to consider...


# Stream Temperature Assessment


## Approach

Taken directly from the SOW:

*The QRF and extrapolation models can be run under existing climate conditions (i.e., assuming current predicted stream water temperatures), as well as under predicted future climate scenarios by incorporating Northwest Stream Temperature (NorWeST) thermal models. Doing so would allow us to compare current predicted habitat capacities to those capacities under various stream temperature warming scenarios, also by species and life-stage. We could also run the QRF model under a theoretical scenario where summer stream temperatures were decreased (e.g., by 1&deg;C) to examine the influence if rehabilitation actions were able to remediate increased summer temperatures. The result would be an evaluation of changes in capacity for Chinook salmon and steelhead under current conditions, a predicted future warming scenario, and a theoretical cooling scenario. This evaluation would only be completed for the summer and spawning (redd) life-stages as the NorWeST model provides information on summer stream temperatures. Additionally, optimal and acute temperature thresholds for summer life-stages of Chinook salmon, steelhead, bull trout, and Pacific lamprey could be compared to available NorWeST temperature models using the aforementioned climate scenarios.*

<!-- 
Finally, a NorWeST summer stream temperature model was used to describe changes in predicted capacity for target species given various changing climate scenarios [@Isaak2012; @Peterson2013; @Isaak2017]
-->


# Limited Species and Life-Stages

What are the limited species and life-stages and why? Include results from a literature review, the habitat capacity assessment, and the stream temperature assessment.


## Target Conditions to Address Limiting Factors

How do we address the identified limiting factors?


# Discussion

Discussion text here...


# Literature Cited

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>


# Supplemental Tables and Figures

## QRF Habitat Capacity Estimates

### Chinook Salmon

```{r chnk-sum-tbl}
chnk_sum_cap %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of currently available habitat for Chinook salmon, **juvenile summer rearing** in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r chnk-win-tbl}
chnk_win_cap %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of currently available habitat for Chinook salmon, **juvenile winter rearing** in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r chnk-redd-tbl}
chnk_redd_cap %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of currently available habitat for Chinook salmon, **spawning (redds)** in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```


### Steelhead

```{r sthd-sum-tbl}
sthd_sum_cap %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of currently available habitat for steelhead, **juvenile summer rearing** in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r sthd-win-tbl}
sthd_win_cap %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of currently available habitat for steelhead, **juvenile winter rearing** in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",

                bootstrap_options = c("striped", "condensed"))

```

```{r sthd-redd-tbl}
sthd_redd_cap %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        caption = "Estimates of currently available habitat for steelhead, **spawning (redds)** in the Upper Walla Walla watershed.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

      
