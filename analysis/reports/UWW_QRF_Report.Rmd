---
title: "Upper Walla Walla Watershed - Habitat Capacity Assessment"
author:
  - Michael W. Ackerman:
      email: mike.ackerman@mthoodenvironmental.com
      institute: [mhe_mccall]
      correspondence: true
  - Tara E. Blackman:
      email: tara.blackman@mthoodenvironmenal.com
      institute: [mhe_sandy]
      correspondence: false
  - Mark Roes:
      email: mark.roes@mthoodenvironmental.com
      institute: [mhe_sandy]
      correspondence: false
  - Kevin E. See:
      email: Kevin.See@dfw.wa.gov
      institute: wdfw
      correspondence: false
institute:
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
  - mhe_sandy: Mount Hood Environmental, 39085 Pioneer Boulevard \#100 Mezzanine, Sandy, Oregon, 97055, USA
  - wdfw: Washington Department of Fish and Wildife, Fish Program, Science Division, 1111 Washington Street NE, Olympia, Washington, 98501, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/american-fisheries-society.csl"
bibliography:
  - AckermanLibrary.bib
---

<!-- the following inserts MHE logo into header -->
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"logo.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)

```

```{r load-libraries}
# run this if running chunks directly

# for formatting
library(kableExtra)
library(ggpubr)

# for analysis
library(sf)
library(here)
library(tidyverse)
library(magrittr)
library(ggmap)
library(nngeo)

theme_set(theme_pubr(x.text.angle = 45,
                     base_size = 8))

```

\newpage

# Background

Water is the conerstone of First Food production and inherently tied to the five fundamental touchstones: hydrology, geomorphology, habitat and network connectivity, riverine biotic community, and riparian vegetation [@Jones2008]. The Umatilla River Vision defines a holistic approach to the restoration of water quality and the implications thereof. Population status and habitat use of riverine fishes defined as First Food (including Endangered Species Act [ESA] listed middle Columbia River summer steelhead, spring-summer run Chinook salmon, bull trout, and Pacific lamprey) are identified as critical data needs in the assessment of biotic communities [@Jones2008]. The decline of anadromous Pacific salmonids (*Oncorhynchus* spp.) across the Pacific Northwest, USA has prompted numerous actions aimed at reversing that trend. These actions are often categorized into four ‘H’s’ - harvest modification, habitat rehabilitation, hydroelectric operations, and hatchery practices. Problematically, substantial uncertainty remains regarding the degree of change to salmon populations that can be exerted across and within these categories, and what combination of changes might most cost-effectively and sustainably reduce mortality and recover depleted populations. Recovery plans (e.g., @NOAA2009) have identified adult escapement targets at the population scale, providing a quantitative metric useful for evaluating the magnitude of survival improvements (across life-stages) required. These abundance targets provide a benchmark against which habitat rehabilitation actions can be measured. Here, we apply a novel approach fo estimating life-stage specific habitat capacity for Chinook salmon and steelhead that can be used to quantitatively identify the magnitude of tributary habitat restoration needed to achieve recovery goals. The necessity of tributary habitat restoration actions can now be demonstrated, and the magnitued of required change can be placed in context with the other ‘H’s’.

We define habitat (carrying) capacity as the maximal abundance or load the stream habitat can support for a given species and life-stage given current resources and physical habitat quantity and quality. Within fisheries research and management, it has long been recognized that biotic and abiotic factors limit productivity within and across life-staged. However, we assume that observed fish density is a poor predictor of habitat capacity owing to both a paucity of individuals and the existence of unmeasured biotic or abiotic variables that may limit capacity. To address this, we have developed a novel approach to estimate the carrying capacity of wadable streams to support spawning and rearing spring-run Chinook salmon and summer-run steelhead  using quantile random forest (QRF; @Meinshausen2006; @Cade2003; @IdahoOSCTeam2019 - Appendix B). While our capacity models specifically address Chinook salmon and steelhead, any uplift in habitat for these species is expected to also uplift bull trout and lamprey.


# Methods

## Focal Species

The focal species for the habitat capacity assessment are:

* Spring-run Chinook salmon (*Oncorhynchus tshawytscha*; hereafter Chinook salmon)
* Middle Columbia River summer steelhead (*O. mykiss*; hereafter steelhead; ESA-listed threatened)

While our habitat capacity models specifically address Chinook salmon and steelhead, any uplift in habitat for these species are expected to also uplift:

* Columbia River bull trout (*Salvelinus confluentus*; ESA-listed threatened)
* Pacific lamprey (*Lampetra tridentata*)


## Study Area

This assessment will be focused on the alluvial channel of the Walla Walla River from the confluence with Dry Creek near Lowden, Washington, to the headwaters of the North and South forks of the Walla Walla River. The primary study area includes approximately 70 miles of stream.


## General Approach

Habitat data from the Columbia Habitat Monitoring Program (CHaMP) were paired to fish survey data to develop fish-habitat relationships. Importantly, the QRF model [@See2021] places no constraints on possible fish-habitat relationships; instead, relationships are estimated from the data regardless of being positive, negative, linear, non-linear, etc. Based on the observed fish-habitat relationships, we then predict habitat capacity at any location using measurements of the same habitat covariates used to populate the model (e.g., at all CHaMP sites). From this, we can extrapolate capacity predictions at CHaMP sites across larger scales (e.g., watershed, population) using globally available attribute data. Here, globally available attribute data available for the Upper Walla Walla River watershed is used to determine capacity at the aforementioned scales. Additionally, we apply a generalized capacity model to estimate life-stage specific capacity requirements and evaluate any deficits (required capacity - available capacity) throughout the Upper Walla Walla River. Finally, a NorWeST summer stream temperature model will be used to describe changes in predicted capacity for target species given various changing climate scenarios [@Isaak2012; @Peterson2013; @Isaak2017].

```{r load-data}
# Upper Walla Walla QRF extrapolations
load(here("analysis/data/derived_data/uww_qrf_extrapolations.rda"))

# Project area polygons and 200m layer (with habitat attributes) within project area
load(here("analysis/data/derived_data/uww_spatial.rda"))

# convert sf objects to tibbles
uww_sum_df = uww_sum_sf %>%
  st_drop_geometry() %>%
  as_tibble()

uww_win_df = uww_win_sf %>%
  st_drop_geometry() %>%
  as_tibble()

uww_redd_df = uww_redd_sf %>%
  st_drop_geometry() %>%
  as_tibble()

```

## Required Capacity

```{r get-params}
params = read_csv(here("analysis/data/raw_data/LifeHistoryParameters.csv"))

rec_goals = tibble(Species = c("Chinook", "Steelhead"),
                   Scenario = "Unknown",
                   Escapement = c(3000, 3400)) %>%
  inner_join(params %>%
               mutate(Parameter = recode(Parameter,
                                         "Female Ratio" = "prop_fem",
                                         "Redds/Female" = "redd_per_fem",
                                         "Fecundity" = "fecund",
                                         "Egg:Parr" = "egg_to_parr",
                                         "Parr:Presmolt" = "parr_to_presmolt")) %>%
               pivot_wider(id_cols = "Species",
                           names_from = "Parameter",
                           values_from = "Value")) %>%
  mutate(`Female Escapement` = Escapement * prop_fem,
         Redds = `Female Escapement` * redd_per_fem,
         Eggs = Redds * fecund,
         `Summer Juveniles` = Eggs * egg_to_parr,
         `Winter Juveniles` = `Summer Juveniles` * parr_to_presmolt) %>%
  select(-c(prop_fem:parr_to_presmolt)) %>%
  pivot_longer(cols = c(Escapement, `Female Escapement`:`Winter Juveniles`),
               names_to = "LifeStage",
               values_to = "Abundance")


```

```{r param-tab}
params %>%
  kable(booktabs = T,
        digits = 3,
        format.args = list(big.mark = ",",
                           drop0trailing = T),
        caption = "Life history parameters for the generalized capacity model.") %>%
  kable_styling(full_width = F,
                position = "center")

```

## Available Capacity

Capacity estimates were generated following the quantile random forest (QRF) framework outlined in @See2021. The method involves fitting a QRF model to paired fish and habitat data across hundreds of sites in seven watersheds within the Columbia River Basin. With  hat model, we predicted fish density at all sites with detailed habitat information. The random forest model produces a distribution of predictions, one for each tree in the forest, and we chose the 90th quantile of that distribution as a proxy for carrying capacity.

### Extrapolation

Although we have hundreds of sites across the Columbia River basin with detailed habitat data, and therefore QRF predictions of capacity at those sites, that really only covers a small percentage of the anadromous zone, even within watersheds with those sites. And many watersheds contain no sites whatsoever. Therefore, to extrapolate our capacity predictions to the areas between these sites, we used a [stream layer](https://www.nwfsc.noaa.gov/research/datatech/data/col_basin_hist_project/index.cfm) available from NOAA fisheries. This layer consists of a polyline shapefile divided into 200m reaches with various attributes attached to each reach. We refer to these as globally available attributes (GAAs) because they are associated with every reach across all watersheds in the Colubia River Basin. The line file is based on the [National Hydrography Dataset High Resolution](https://www.usgs.gov/core-science-systems/ngp/national-hydrography/nhdplus-high-resolution) (NHDPlus HR) dataset, which has a high resolution, 1:24,000.

We determined which reach was closest to each site with predicted capacity, and then fit a different random forest model using the predicted capacity (in either linear or areal density) as the response, and various GAAs as the covariates. The nature of the random forest models allows for non-linear associations between capacity and some GAAs, while also preventing the extrapolation from growing beyond the largest predicted capacities in our initial dataset. We calculated the standard error of our predictions by the standard deviation of the random forest predicted distribution at each reach. The capacity of each 200m reach is calculated by multiplying the predicted fish/m capacity by the length of that reach. To determine the total capacity for a specified region, the capacities of each reach within that region are summed.

```{r calc-chnk-capacity}
source(here("R/calc_watershed_cap.R"))

# Chinook salmon, summer parr
chnk_sum_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_sum_sf,
                                  capacity_name = "chnk_per_m",
                                  capacity_se_name = "chnk_per_m_se",
                                  by_stream = T)

# Chinook salmon, winter presmolt
chnk_win_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_win_sf,
                                  capacity_name = "chnk_per_m",
                                  capacity_se_name = "chnk_per_m_se",
                                  by_stream = T)

# Chinook salmon, redds
chnk_redd_cap = calc_watershed_cap(uww_huc_sf,
                                   uww_redd_sf,
                                   capacity_name = "chnk_per_m",
                                   capacity_se_name = "chnk_per_m_se",
                                   by_stream = T)

```

```{r calc-sthd-capacity}
# steelhead, summer parr
sthd_sum_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_sum_sf,
                                  capacity_name = "sthd_per_m",
                                  capacity_se_name = "sthd_per_m_se",
                                  by_stream = T)

# steelhead, winter presmolt
sthd_win_cap = calc_watershed_cap(uww_huc_sf,
                                  uww_win_sf,
                                  capacity_name = "sthd_per_m",
                                  capacity_se_name = "sthd_per_m_se",
                                  by_stream = T)

# steelhead, redds
sthd_redd_cap = calc_watershed_cap(uww_huc_sf,
                                   uww_redd_sf,
                                   capacity_name = "sthd_per_m",
                                   capacity_se_name = "sthd_per_m_se",
                                   by_stream = T)

```

```{r compile-capacity}
cap_totals = list(chnk_sum = chnk_sum_cap,
                  chnk_win = chnk_win_cap,
                  chnk_redd = chnk_redd_cap,
                  sthd_sum = sthd_sum_cap,
                  sthd_win = sthd_win_cap,
                  sthd_redd = sthd_redd_cap) %>%
  map_df(.id = "type",
        .f = function(x) {
          x %>%
            filter(StreamName == "Total")
        }) %>%
  mutate(Species = str_split(type, "_", simplify = T)[ ,1],
         LifeStage = str_split(type, "_", simplify = T)[ ,2]) %>%
  mutate(Species = recode(Species,
                          "chnk" = "Chinook",
                          "sthd" = "Steelhead"),
         LifeStage = recode(LifeStage,
                            "sum" = "Summer Juveniles",
                            "win" = "Winter Juveniles",
                            "redd" = "Redds")) %>%
  select(Species,
         LifeStage,
         everything(),
         -StreamName,
         -type)

```

## Capacity Limitations

# Results

## Required Capacity

## Available Capacity

Estimates of total capacity by each life-stage and species in the watershed are showin in Table \@ref(tab:cap-table). Maps of the capacity extrapolations are shown in Figures \@ref(fig:chnk-maps) and \@ref(fig:sthd-maps).

```{r cap-table}
cap_totals %>%
  mutate(avg_cap_per_m = tot_cap / tot_length) %>%
  mutate(tot_length_km = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length_km,
         Capacity = tot_cap,
         SE = tot_cap_se,
         `Avg. Capacity / m` = avg_cap_per_m) %>%
  select(Species,
         LifeStage,
         `n Reaches`,
         `Stream Length (km)`,
         Capacity,
         SE,
         `Avg. Capacity / m`) %>%
  kable(booktabs = T,
        digits = c(0, 0, 1, 0, 0, 0, 3),
        format.args = list(big.mark = ","),
        caption = "Estimates of current available watershed capacity by species and life-stage.") %>%
  kable_styling()

```

```{r create-chnk-maps}
# pick a background river color
river_color = "lightskyblue1"

# chinook summer parr
chnk_sum_map = uww_sum_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_sum_sf %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Chinook Salmon",
       color = expression(`Summer Juv` / m^2))

# chinook winter presmolts
chnk_win_map = uww_win_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_win_sf %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Chinook Salmon",
       color = expression(`Winter Juv` / m^2))

# chinook redds
chnk_redd_map = uww_redd_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_redd_sf %>%
            filter(chnk) %>%
            mutate(chnk_per_km = chnk_per_m * 1000),
          aes(color = chnk_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Chinook Salmon",
       color = expression(Redds / km))
    

```

```{r create-sthd-maps}
# steelhead summer juveniles
sthd_sum_map = uww_sum_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_sum_sf %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Steelhead",
       color = expression(`Summer Juv` / m^2))

# steelhead winter juveniles
sthd_win_map = uww_win_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_win_sf %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Steelhead",
       color = expression(`Winter Juv` / m^2))

# steelhead redds
sthd_redd_map = uww_redd_sf %>%
  ggplot() +
  geom_sf(data = uww_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = uww_redd_sf %>%
            filter(sthd) %>%
            mutate(sthd_per_km = sthd_per_m * 1000),
          aes(color = sthd_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Steelhead",
       color = expression(Redds / km))

```

```{r chnk-maps, fig.cap = "Extrapolations of habitat capacity for Chinook salmon, by life-stage, within the Upper Walla Walla watershed."}
ggarrange(chnk_sum_map,
          chnk_win_map,
          chnk_redd_map)

```

```{r sthd-maps, fig.cap = "Extrapolations of habitat capacity for steelhead, by life-stage, within the Upper Walla Walla watershed."}
ggarrange(sthd_sum_map,
          sthd_win_map,
          sthd_redd_map)

```

## Capacity Limitations

```{r cap-limits}
rec_goals %>%
  left_join(cap_totals %>%
              select(-n_rchs,
                     -tot_length)) %>%
  mutate(Deficit = Abundance - tot_cap,
         `Relative Deficit` = Deficit / tot_cap) %>%
  rename(`Required Capacity` = Abundance,
         `Available Capacity` = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,0,0,0,0,0,2),
        format.args = list(big.mark = ","),
        caption = "Capacity deficits and relative deficits based on recovery goals.") %>%
  kable_styling()

```

# Inference and Discussion

# References
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

      
